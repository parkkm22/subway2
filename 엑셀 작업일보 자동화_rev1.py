import streamlit as st
import pandas as pd
from datetime import datetime
import os
import google.generativeai as genai
import io
import PyPDF2
import re
import pdfplumber
from pdf2image import convert_from_bytes
from PIL import Image
from openpyxl import load_workbook
from openpyxl.utils.dataframe import dataframe_to_rows

# ë°œíŒŒë°ì´í„° ì¶”ì¶œ í”„ë¡¬í”„íŠ¸ (ê°„ê²° ë²„ì „)
BLAST_EXTRACTION_PROMPT = '''
# Instruction
ë‹¤ìŒ ë‘ ê°œì˜ TSV í˜•ì‹ ë¬¸ìì—´ (ì²« ë²ˆì§¸ëŠ” ë°œíŒŒì‘ì—…ì¼ì§€ TSV, ë‘ ë²ˆì§¸ëŠ” ê³„ì¸¡ì¼ì§€ TSV)ì„ ì…ë ¥ìœ¼ë¡œ ë°›ì•„, ì§€ì •ëœ ê·œì¹™ì— ë”°ë¼ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³  ë³‘í•©í•˜ì—¬ ìµœì¢… TSV(UTF-8) í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•˜ì„¸ìš”.

## ì…ë ¥ 1: ë°œíŒŒì‘ì—…ì¼ì§€_TSV
- ë‚´ìš©: ë°œíŒŒì‘ì—…ì¼ì§€ PDFì—ì„œ ì¶”ì¶œëœ ë°ì´í„°ì…ë‹ˆë‹¤.
- ì»¬ëŸ¼ ì˜ˆì‹œ: ë°œíŒŒì¼ì, ë°œíŒŒì‹œê°„, ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg), ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg), í­ì•½ì‚¬ìš©ëŸ‰(kg), ë¹„ê³ 
- ì‹¤ì œ ë°ì´í„° ì˜ˆì‹œ (ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ì œê³µë¨):
ë°œíŒŒì¼ì\\të°œíŒŒì‹œê°„\\tì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg)\\tì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg)\\tí­ì•½ì‚¬ìš©ëŸ‰(kg)\\të¹„ê³ 
2023-07-27\\t08:05\\t0.5\\t0.9\\t73\\tPLA-2
2023-07-27\\t13:47\\t0.4\\t0.8\\t77\\tPD-2
(ì°¸ê³ : ì‹¤ì œ ì…ë ¥ë˜ëŠ” ì»¬ëŸ¼ëª…ê³¼ ê°’, ë‚ ì§œ/ì‹œê°„ í˜•ì‹ì€ ì›ë³¸ PDFì˜ ê²ƒì„ ë”°ë¦…ë‹ˆë‹¤.)

## ì…ë ¥ 2: ê³„ì¸¡ì¼ì§€_TSV
- ë‚´ìš©: ë°œíŒŒì§„ë™ì†ŒìŒ ê³„ì¸¡ì¼ì§€ PDFì—ì„œ ì¶”ì¶œëœ ë°ì´í„°ì…ë‹ˆë‹¤. \\\'ì¸¡ì •ìœ„ì¹˜\\\'ëŠ” ì´ë¯¸ ê° í–‰ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
- ì»¬ëŸ¼ ì˜ˆì‹œ: Date/Time, Peak Particle Vel (X_Axis) (mm/sec), Peak Particle Vel (Y_Axis) (mm/sec), Peak Particle Vel (Z_Axis) (mm/sec), LMax (Sound) (dBA), ì¸¡ì •ìœ„ì¹˜
- ì‹¤ì œ ë°ì´í„° ì˜ˆì‹œ (ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ì œê³µë¨):
Date/Time\\tPeak Particle Vel (X_Axis) (mm/sec)\\tPeak Particle Vel (Y_Axis) (mm/sec)\\tPeak Particle Vel (Z_Axis) (mm/sec)\\tLMax (Sound) (dBA)\\tì¸¡ì •ìœ„ì¹˜
2023/07/27 1:47:00 PM\\t0.71\\t0.36\\t0.71\\t61.23\\tì–‘ë§ì§‘
2023/07/27 1:47:00 PM\\t0.87\\t0.56\\t0.87\\t53.29\\tí‹°ìŠ¤í…Œì´ì…˜
(ì°¸ê³ : ì‹¤ì œ ì…ë ¥ë˜ëŠ” ì»¬ëŸ¼ëª…, ê°’, ë‚ ì§œ/ì‹œê°„ í˜•ì‹ì€ ì›ë³¸ PDFì˜ ê²ƒì„ ë”°ë¦…ë‹ˆë‹¤.)

# Output
1. í˜•ì‹: TSV(UTF-8)
2. ì •ë ¬ ê¸°ì¤€: "ë°œíŒŒì‹œê°„" ì˜¤ë¦„ì°¨ìˆœ, ê·¸ ë‹¤ìŒ "ê³„ì¸¡ìœ„ì¹˜" ì˜¤ë¦„ì°¨ìˆœ (í•„ìš”ì‹œ)
3. ìµœì¢… í—¤ë”(ê³ ì •ì—´): ë°œíŒŒì¼ì, ë°œíŒŒì‹œê°„, ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg), ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg), í­ì•½ì‚¬ìš©ëŸ‰(kg), ë°œíŒŒì§„ë™(cm/sec), ë°œíŒŒì†ŒìŒ(dB(A)), ê³„ì¸¡ìœ„ì¹˜, ë¹„ê³ 
4. **ì¤‘ìš” ì¶œë ¥ ê·œì¹™**: ì˜¤ì§ ìµœì¢… TSV ë°ì´í„°ë§Œ ì¶œë ¥í•´ì•¼ í•˜ë©°, ë‹¤ë¥¸ ì„¤ëª…, ë¶„ì„ ë‚´ìš©, ì£¼ì„, ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì€ ì ˆëŒ€ í¬í•¨í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.

# ì¶”ì¶œ, ë³€í™˜ ë° ë³‘í•© ê·œì¹™
(ì´í•˜ ê·œì¹™ì€ ì´ì „ê³¼ ë™ì¼)
1.  **ê¸°ì¤€**: \\\'ë°œíŒŒì‘ì—…ì¼ì§€_TSV\\\'ì˜ ê° í–‰ì„ ê¸°ì¤€ìœ¼ë¡œ, \\\'ê³„ì¸¡ì¼ì§€_TSV\\\'ì™€ ë°ì´í„°ë¥¼ ë³‘í•©í•©ë‹ˆë‹¤.
2.  **ë°œíŒŒì¼ì**: \\\'ë°œíŒŒì‘ì—…ì¼ì§€_TSV\\\'ì˜ ë‚ ì§œ ì •ë³´ë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
3.  **ë°œíŒŒì‹œê°„ (ë§¤ì¹­ ê¸°ì¤€)**: \\\'ë°œíŒŒì‘ì—…ì¼ì§€_TSV\\\'ì˜ ì‹œê°„ ì •ë³´ë¥¼ HH:MM (24ì‹œê°„ì œ) í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë§¤ì¹­ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
4.  **ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg)**, **ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg)**, **í­ì•½ì‚¬ìš©ëŸ‰(kg)**, **ë¹„ê³ **:
    - \\\'ë°œíŒŒì‘ì—…ì¼ì§€_TSV\\\'ì—ì„œ í•´ë‹¹ ë°œíŒŒì‹œê°„ì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
5.  **ê³„ì¸¡ì¼ì§€ ì‹œê°„ ë³€í™˜**: \\\'ê³„ì¸¡ì¼ì§€_TSV\\\'ì˜ ì‹œê°„ ì •ë³´ë¥¼ HH:MM (24ì‹œê°„ì œ) í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
6.  **ë°ì´í„° ë§¤ì¹­**: \\\'ë°œíŒŒì‘ì—…ì¼ì§€_TSV\\\'ì˜ (ë³€í™˜ëœ) \\\'ë°œíŒŒì‹œê°„\\\'ê³¼ \\\'ê³„ì¸¡ì¼ì§€_TSV\\\'ì˜ (ë³€í™˜ëœ) \\\'ì‹œê°„\\\'ì„ ë¹„êµí•˜ì—¬ ì¼ì¹˜í•˜ëŠ” ëª¨ë“  í–‰ì„ ì°¾ìŠµë‹ˆë‹¤.
7.  **ë°œíŒŒì§„ë™(cm/sec)**:
    1.  ì‹œê°„ì´ ë§¤ì¹­ëœ \\\'ê³„ì¸¡ì¼ì§€_TSV\\\' í–‰ì—ì„œ X, Y, Zì¶• ì§„ë™ ê°’ ì¤‘ **ìµœëŒ“ê°’**ì„ ì„ íƒ (ë‹¨ìœ„: mm/sec).
    2.  ì„ íƒëœ ê°’ì„ 10ìœ¼ë¡œ ë‚˜ëˆ  cm/secë¡œ ë³€í™˜ í›„ ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ.
    3.  ë§¤ì¹­ë˜ëŠ” ê³„ì¸¡ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ \\\"-\\\"ë¡œ í‘œì‹œ.
8.  **ë°œíŒŒì†ŒìŒ(dB(A))**: ì‹œê°„ì´ ë§¤ì¹­ëœ \\\'ê³„ì¸¡ì¼ì§€_TSV\\\' í–‰ì˜ ì†ŒìŒ ê°’ì„ ì†Œìˆ˜ì  ì…‹ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œ. ì—†ìœ¼ë©´ \\\"-\\\".
9.  **ê³„ì¸¡ìœ„ì¹˜**: ì‹œê°„ì´ ë§¤ì¹­ëœ \\\'ê³„ì¸¡ì¼ì§€_TSV\\\' í–‰ì˜ \\\'ì¸¡ì •ìœ„ì¹˜\\\' ê°’ì„ ì‚¬ìš©. ì—†ìœ¼ë©´ \\\"-\\\".
10. **ë‹¤ì¤‘ ê³„ì¸¡ ë°ì´í„° ì²˜ë¦¬ (ì¤‘ìš”)**:
    - í•˜ë‚˜ì˜ \\\'ë°œíŒŒì‘ì—…ì¼ì§€_TSV\\\' í–‰(íŠ¹ì • ë°œíŒŒì‹œê°„)ì— ëŒ€í•´, \\\'ê³„ì¸¡ì¼ì§€_TSV\\\'ì—ì„œ ì—¬ëŸ¬ ê°œì˜ ë§¤ì¹­ë˜ëŠ” í–‰ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ë³´í†µ ê³„ì¸¡ìœ„ì¹˜ê°€ ë‹¤ë¥¸ ê²½ìš°).
    - ì´ ê²½ìš°, ìµœì¢… ì¶œë ¥ í…Œì´ë¸”ì— ê° ë§¤ì¹­ ê±´ë‹¹ í•˜ë‚˜ì˜ í–‰ì„ ìƒì„±í•©ë‹ˆë‹¤.
    - ì²« ë²ˆì§¸ ìƒì„±ëœ í–‰(í•´ë‹¹ ë°œíŒŒì‹œê°„ì˜ ì²« ë²ˆì§¸ ê³„ì¸¡ ë°ì´í„°)ì—ë§Œ **ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg)**, **ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg)**, **í­ì•½ì‚¬ìš©ëŸ‰(kg)** ê°’ì„ í‘œì‹œí•©ë‹ˆë‹¤.
    - ë™ì¼ ë°œíŒŒì‹œê°„ì˜ ë‘ ë²ˆì§¸ ì´í›„ ë§¤ì¹­ í–‰ì—ëŠ” ì´ ì„¸ ê°€ì§€ ê°’ì„ \\\"-\\\"ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.
    - **ë°œíŒŒì¼ì, ë°œíŒŒì‹œê°„, ë¹„ê³ **ëŠ” í•´ë‹¹ ë°œíŒŒì‹œê°„ì˜ ëª¨ë“  ë§¤ì¹­ í–‰ì— ë™ì¼í•˜ê²Œ ë°˜ë³µ í‘œì‹œí•©ë‹ˆë‹¤.
    - **ë°œíŒŒì§„ë™(cm/sec), ë°œíŒŒì†ŒìŒ(dB(A)), ê³„ì¸¡ìœ„ì¹˜**ëŠ” ê° ë§¤ì¹­ëœ ê³„ì¸¡ì¼ì§€ í–‰ì˜ ê°’ì„ ë”°ë¦…ë‹ˆë‹¤.
11. **ìˆ«ì í¬ë§· ë° ê°’ ë¶€ì¬**: ëª¨ë“  ìˆ˜ì¹˜ëŠ” ìš”êµ¬ë˜ëŠ” ì†Œìˆ˜ì  ìë¦¬ê¹Œì§€ í‘œê¸°í•˜ê³ , ê°’ì´ ì—†ê±°ë‚˜ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ \\\"-\\\"ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. ëª¨ë“  í…ìŠ¤íŠ¸ ê°’ì€ ê·¸ëŒ€ë¡œ ìœ ì§€í•©ë‹ˆë‹¤.

# ìµœì¢… ì¶œë ¥ ì˜ˆì‹œ (ì•„ë˜ ì˜ˆì‹œëŠ” ìµœì¢… ì¶œë ¥ í˜•ì‹ì„ ë³´ì—¬ì£¼ê¸° ìœ„í•¨ì´ë©°, ì‹¤ì œ ë‚´ìš©ì€ ì…ë ¥ ë°ì´í„°ì— ë”°ë¼ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.)
ë°œíŒŒì¼ì\\të°œíŒŒì‹œê°„\\tì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg)\\tì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg)\\tí­ì•½ì‚¬ìš©ëŸ‰(kg)\\të°œíŒŒì§„ë™(cm/sec)\\të°œíŒŒì†ŒìŒ(dB(A))\\tê³„ì¸¡ìœ„ì¹˜\\të¹„ê³ 
[ë‚ ì§œ]\\t[ì‹œê°„1]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t-\\t-\\t-\\t[ë¹„ê³ 1]
[ë‚ ì§œ]\\t[ì‹œê°„2]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t[ìœ„ì¹˜1]\\t[ë¹„ê³ 2]
[ë‚ ì§œ]\\t[ì‹œê°„2]\\t-\\t-\\t-\\t[ê°’]\\t[ê°’]\\t[ìœ„ì¹˜2]\\t[ë¹„ê³ 2]
[ë‚ ì§œ]\\t[ì‹œê°„3]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t[ìœ„ì¹˜3]\\t[ë¹„ê³ 3]
[ë‚ ì§œ]\\t[ì‹œê°„3]\\t-\\t-\\t-\\t[ê°’]\\t[ê°’]\\t[ìœ„ì¹˜4]\\t[ë¹„ê³ 3]
[ë‚ ì§œ]\\t[ì‹œê°„4]\\t[ê°’]\\t[ê°’]\\t[ê°’]\\t-\\t-\\t-\\t[ë¹„ê³ 4]

**ë§¤ìš° ì¤‘ìš”**: ë‹¤ë¥¸ ì–´ë–¤ í…ìŠ¤íŠ¸, ì„¤ëª…, ë¶„ì„, ì£¼ì„, ë§ˆí¬ë‹¤ìš´ë„ ì—†ì´, ìœ„ì— ì œì‹œëœ \\\'ìµœì¢… ì¶œë ¥ ì˜ˆì‹œ\\\'ì™€ ì •í™•íˆ ë™ì¼í•œ í˜•ì‹ì˜ TSV ë°ì´í„°ë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤. ì´ ì§€ì¹¨ì„ ë°˜ë“œì‹œ ì—„ê²©í•˜ê²Œ ì¤€ìˆ˜í•˜ì‹­ì‹œì˜¤.
'''

# Gemini API í‚¤ ì„¤ì •
GENAI_API_KEY = "AIzaSyD69-wKYfZSID327fczrkx-JveJdGYIUIk" # ì´ ë¶€ë¶„ì€ ì‹¤ì œ í‚¤ë¡œ ëŒ€ì²´ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
genai.configure(api_key=GENAI_API_KEY)

# Gemini ëª¨ë¸ ê°ì²´ ìƒì„±
GEMINI_MODEL = genai.GenerativeModel("models/gemini-2.5-flash-preview-05-20")

DEFAULT_PROMPT = """
# INSTRUCTIONS
1. ê¸°ìƒì²­ ì„œìš¸ ì§€ì—­ ê´€ì¸¡ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ "ë‚ ì”¨ì •ë³´" í…Œì´ë¸”ì„ TSV(UTF-8) í˜•ì‹ì˜ ë³„ë„ ì½”ë“œë¸”ë¡ìœ¼ë¡œ ìƒì„±
2. ì¼ì¼ì‘ì—…ë³´ê³  ì›ë¬¸ì—ì„œ ë°ì´í„°ë¥¼ íŒŒì‹±í•˜ì—¬ 4ê°œ í…Œì´ë¸”("ì‹œê³µí˜„í™©", "ì‘ì—…ë‚´ìš©", "ì¸ì›", "ì¥ë¹„") ê°ê°ì„ TSV(UTF-8) í˜•ì‹ì˜ ë³„ë„ ì½”ë“œë¸”ë¡ìœ¼ë¡œ ì°¨ë¡€ëŒ€ë¡œ ì¶œë ¥í•˜ë©° ì•„ë˜ì˜ ì¡°ê±´ì„ ì² ì €íˆ ì¤€ìˆ˜í•  ê²ƒ

# OUTPUT : í…Œì´ë¸”(ì´ 5ê°œ)  
## 1. ë‚ ì”¨ì •ë³´ í…Œì´ë¸”
1. ê³ ì • ì—´ : "êµ¬ë¶„", "ê°’"
2. ê³ ì • í–‰ : "ìµœê³ ì˜¨ë„", "ìµœì €ì˜¨ë„", "ê°•ìˆ˜ëŸ‰"
3. ì¶”ì¶œë°ì´í„° : ì„œìš¸(ìœ ) ì˜¤ëŠ˜ ë‚ ì”¨ ì˜ˆë³´ (ìµœì‹  ì—…ë°ì´íŠ¸)
4. ì£¼ì˜ì‚¬í•­ 
- ì„œìš¸ ì§€ì—­(ì˜ë“±í¬êµ¬ ìš°ì„ )ì˜ ìµœê³  ê¸°ì˜¨, ìµœì € ê¸°ì˜¨, ê°•ìˆ˜ëŸ‰ì˜ ë‹¨ì¼ê°’ ì¶”ì¶œ
- ë°ì´í„°ëŠ” ìµœì‹  ì—…ë°ì´íŠ¸ëœ ê¸°ìƒì²­ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì œê³µ
- "ê°’"ë§Œ ìˆ«ìë¡œ ì¶”ì¶œí•  ê²ƒ (ì˜ˆ: 20.0 Â°Cì—ì„œ "20.0" ì¶”ì¶œ)

## 2. ì‹œê³µí˜„í™© í…Œì´ë¸”  
1. ê³ ì • ì—´ : "êµ¬ë¶„", "ëˆ„ê³„"  
2. ê³ ì • í–‰(ì´ 33í–‰) - ì•„ë˜ ìˆœì„œì™€ ëª…ì¹­ì„ ê·¸ëŒ€ë¡œ  
- "1. ë³¸ì„ í„°ë„ (1êµ¬ê°„, ëŒ€ë¦¼-ì‹ í’) êµ´ì°©"  
- "1. ë³¸ì„ í„°ë„ (1êµ¬ê°„, ëŒ€ë¦¼-ì‹ í’) ë¼ì´ë‹" 
- "2. ì‹ í’ì •ê±°ì¥ - 1)ì •ê±°ì¥ ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 1)ì •ê±°ì¥ ë¯¸ë“¤ ìŠ¬ë¼ë¸Œ"
- "2. ì‹ í’ì •ê±°ì¥ â€“ 2)ì£¼ì¶œì…êµ¬ ìˆ˜ì§êµ¬ ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (1)PCB ì •ê±°ì¥ ë°©ë©´ ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (1)PCB í™˜ìŠ¹í†µë¡œ ë°©ë©´ ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (2)PCC ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (3)PCD ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (4)PHA ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 3)íŠ¹ë³„í”¼ë‚œê³„ë‹¨ - ìˆ˜ì§êµ¬ ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 3)íŠ¹ë³„í”¼ë‚œê³„ë‹¨ - PHB ë¼ì´ë‹"
- "2. ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬ ì¶œì…êµ¬(#3) êµ´ì°©" 
- "2. ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬ ì¶œì…êµ¬(#2) êµ´ì°©"
- "2. ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬ ì¶œì…êµ¬(#1) êµ´ì°©" 
- "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCF) êµ´ì°©" 
- "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCF) ë¼ì´ë‹"  
- "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCE) êµ´ì°©" 
- "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„ ì—°ê²°í„°ë„(PCE) ë¼ì´ë‹"  
- "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 2)ê°œì°© BOX ë³´ë¼ë§¤ ë°©ë©´ êµ¬ì¡°ë¬¼"  
- "3. ì‹ í’ í™˜ìŠ¹í†µë¡œ - 2)ê°œì°© BOX ëŒ€ë¦¼ ë°©ë©´ êµ´ì°©"  
- "4. ë³¸ì„ í„°ë„(2êµ¬ê°„, ì‹ í’-ë„ë¦¼) êµ´ì°©"  
- "4. ë³¸ì„ í„°ë„(2êµ¬ê°„, ì‹ í’-ë„ë¦¼) ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 1)ì •ê±°ì¥ í„°ë„ ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 1)ì •ê±°ì¥ ë¯¸ë“¤ ìŠ¬ë¼ë¸Œ" 
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 ìˆ˜ì§êµ¬ ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 PCA ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 PCC ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1 PHA ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 ìˆ˜ì§êµ¬ ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 PCA ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 PCC ë¼ì´ë‹"  
- "5. ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2 PHB ë¼ì´ë‹"  
3. ì¶”ì¶œë°ì´í„°  
- "ëˆ„ê³„"ê°’ë§Œ ìˆ«ìë¡œ ì¶”ì¶œí•  ê²ƒ (ì˜ˆ: 945.3m / 1,116m ì—ì„œ "945.3" ì¶”ì¶œ)
 
## 3. ì‘ì—…ë‚´ìš© í…Œì´ë¸”  
1. ê³ ì • ì—´ : "êµ¬ë¶„", "ê¸ˆì¼ì‘ì—…"  
2. ê³ ì • í–‰(ì´ 14í–‰) - ì•„ë˜ ìˆœì„œì™€ ëª…ì¹­(ë§¤í•‘ í›„ ê²°ê³¼)ì„ ê·¸ëŒ€ë¡œ  
- "1. ë³¸ì„ í„°ë„ (1êµ¬ê°„, ëŒ€ë¦¼-ì‹ í’)"  
- "2.ì‹ í’ì •ê±°ì¥ - 1)ì •ê±°ì¥ í„°ë„"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (1)PCB"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (2)PCC"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (3)PCD"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (4)PHA"  
- "2.ì‹ í’ì •ê±°ì¥ - 3)íŠ¹ë³„í”¼ë‚œê³„ë‹¨"  
- "2.ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬"  
- "3.ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„"  
- "3.ì‹ í’ í™˜ìŠ¹í†µë¡œ - 2)ê°œì°© BOX"  
- "4.ë³¸ì„ í„°ë„(2êµ¬ê°„, ì‹ í’-ë„ë¦¼)"  
- "5.ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 1)ì •ê±°ì¥ í„°ë„"  
- "5.ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1"  
- "5.ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2"  
3. ì£¼ì˜ì‚¬í•­  
- 'ì‘ì—…ë‚´ìš©' ì…€ì€ ì—¬ëŸ¬ ì„¸ë¶€ ë‚´ìš©ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‚´ìš©ì„ êµ¬ë¶„í•  ë•ŒëŠ”, ìµœì¢… TSV ì¶œë ¥ ì‹œ í•´ë‹¹ ì…€ì„ í°ë”°ì˜´í‘œ("...")ë¡œ ê°ì‹¸ë˜, ì…€ ë‚´ë¶€ì˜ ê° ë‚´ìš©ì€ **ì‹¤ì œ ì¤„ë°”ê¿ˆ ë¬¸ì(ì˜ˆ: '\n' ë¬¸ìì—´ ëŒ€ì‹  ì—”í„° í‚¤ ì…ë ¥ì— í•´ë‹¹)**ë¥¼ ì‚¬ìš©í•˜ì—¬ ë¶„ë¦¬í•˜ë©°, '-'ê¸°í˜¸ëŠ” ìƒëµí•¨

## 4. ì¸ì› / ì¥ë¹„ í…Œì´ë¸”  
1. ê³ ì • ì—´ (ì´ 15ì—´) - ì—´ ìˆœì„œëŠ” ì•„ë˜ì™€ ê°™ìŒ
- "êµ¬ë¶„" 
- "1. ë³¸ì„ í„°ë„ (1êµ¬ê°„, ëŒ€ë¦¼~ì‹ í’)"  
- "2.ì‹ í’ì •ê±°ì¥ - 1)ì •ê±°ì¥ í„°ë„"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (1)PCB"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (2)PCC"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (3)PCD"  
- "2.ì‹ í’ì •ê±°ì¥ - 2)ì£¼ì¶œì…êµ¬ - (4)PHA"  
- "2.ì‹ í’ì •ê±°ì¥ - 3)íŠ¹ë³„í”¼ë‚œê³„ë‹¨"  
- "2.ì‹ í’ì •ê±°ì¥ - 4)ì™¸ë¶€ì¶œì…êµ¬"  
- "3.ì‹ í’ í™˜ìŠ¹í†µë¡œ - 1)í™˜ìŠ¹í„°ë„"  
- "3.ì‹ í’ í™˜ìŠ¹í†µë¡œ - 2)ê°œì°© BOX"  
- "4.ë³¸ì„ í„°ë„(2êµ¬ê°„, ì‹ í’~ë„ë¦¼)"  
- "5.ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 1)ì •ê±°ì¥ í„°ë„"  
- "5.ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 2)ì¶œì…êµ¬#1"  
- "5.ë„ë¦¼ì‚¬ê±°ë¦¬ì •ê±°ì¥ - 3)ì¶œì…êµ¬#2"    

2. ê³ ì • í–‰(ì¸ì› í…Œì´ë¸” â€“ ì´ 36í–‰)  
(ì¸ì› ëª©ë¡ì€ ì•„ë˜ ìˆœì„œì™€ ëª…ì¹­(ë§¤í•‘ í›„ ê²°ê³¼)ì„ ë°˜ë“œì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©):

"ì§ì˜ë°˜ì¥", "ì—°ìˆ˜ìƒ", "ì¥ë¹„ìš´ì „ì›", "ì „ê¸°ì£¼ì„", "í™”ì•½ì£¼ì„", "í„°ë„ê³µ", "ëª©ê³µ", "ì² ê·¼ê³µ", "ë¼ì´ë‹í¼ê³µ", "ì˜¤íìˆ˜ì²˜ë¦¬ê³µ", "ì¹´ë¦¬í”„íŠ¸ê³µ", "BPê³µ", "ê°€ì‹œì„¤ê³µ", "ì„¤ì¹˜ê³µ/í•´ì²´ê³µ", "ë™ë°”ë¦¬ê³µ", "ì‹ í˜¸ìˆ˜", "ë¶€ë‹¨ìˆ˜ê³µ", "ìŠ¬ëŸ¬ë¦¬ì›”ê³µ", "CIPê³µ", "ë¯¸ì¥ê³µ", "ì‹œì„¤ë¬¼ê³µ", "ê²½ê³„ì„ê³µ", "ì¡°ê²½ê³µ", "ë°°ê´€ê³µ", "ë„ìƒ‰ê³µ", "ë°©ìˆ˜ê³µ", "ì¥ë¹„/ì‘ì—…ì§€í‚´ì´", "ë³´í†µì¸ë¶€", "í¬ì¥ê³µ", "ìš©ì ‘ê³µ", "íƒ€ì„¤ê³µ", "ë³´ë§ê³µ/ì•™ì¹´ê³µ", "ë¹„ê³„ê³µ", "ë„ì¥ê³µ", "ì„ë©´ê³µ", "ì£¼ì…ê³µ/ê·¸ë¼ìš°íŒ…ê³µ"

3. ê³ ì • í–‰ (ì¥ë¹„ í…Œì´ë¸” â€“ ì´ 46í–‰)  
(ì¥ë¹„ ëª©ë¡ì€ ì•„ë˜ ìˆœì„œì™€ ëª…ì¹­(ë§¤í•‘ í›„ ê²°ê³¼)ì„ ë°˜ë“œì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©):

"B/H(1.0LC)", "B/H(08W)", "B/H(08LC)", "B/H(06W)", "B/H(06LC)", "B/H(03LC)", "B/H(02LC)", "B/H(015)", "ë¤í”„íŠ¸ëŸ­(5T)", "ë¤í”„íŠ¸ëŸ­(15T)", "ë¤í”„íŠ¸ëŸ­(25T)", "ì•µê¸€í¬ë ˆì¸(100T)", "ì•µê¸€í¬ë ˆì¸(80T)", "ì•µê¸€í¬ë ˆì¸(35T)", "ì•µê¸€í¬ë ˆì¸(25T)", "ì¹´ê³ í¬ë ˆì¸(25T)", "ì¹´ê³ í¬ë ˆì¸(5T)", "ì½¤í”„", "ì ë³´ë“œë¦´", "í˜ì´ë¡œë”", "ìˆíŠ¸ë¨¸ì‹ ", "ì°¨ì§•ì¹´", "ì‚´ìˆ˜ì°¨", "í•˜ì´ë“œë¡œí¬ë ˆì¸", "ë¯¹ì„œíŠ¸ëŸ­", "í™”ë¬¼ì°¨(5T)", "íŒí”„ì¹´", "ìŠ¤ì¹´ì´", "ì½˜í¬ë¦¬íŠ¸í”¼ë‹ˆì…”", "ì „ì£¼ì˜¤ê±°", "ë¡œë”(ë°”ë¸Œì¼“)", "ìœ ì œì‚´í¬ê¸°(ë¹„ìš°ë‹¤)", "ì§€ê²Œì°¨", "ì‹¸ì¸ì¹´", "BCì»¤í„°ê¸°", "ë°”ì´ë¸Œë¡œí•´ë¨¸", "ë¡¤ëŸ¬(2.5T)", "ë¡¤ëŸ¬(1T)", "ë¡¤ëŸ¬(0.7T)", "ëª°ë¦¬", "í•­íƒ€ê¸°", "í¬ë ˆì¸", "ì½¤ë¹„ë¡œë¼", "ê³µì••ë“œë¦´", "ìœ ì••ë“œë¦´", "ê¸°íƒ€"

## 5. Parsing Rules 
1. ì‹œê³µí˜„í™©: "ëˆ„ê³„/ì„¤ê³„" â†’ **ì• ê°’(ì†Œìˆ˜ í—ˆìš©)** ë§Œ ì¶”ì¶œ.    
2. ì¸ì›Â·ì¥ë¹„: íˆ¬ì…í˜„í™©ì—ì„œ **ì •ìˆ˜ë§Œ** ì¶”ì¶œ, ë¹ˆì…€ì€ **0**    
3. í•˜ìœ„ ì„¹ì…˜ ë§¤í•‘    
   - ì •ê±°ì¥ í„°ë„ â†’ ì—´ â‘¡, PCB â†’ â‘¢, PCC â†’ â‘£, PCD â†’ â‘¤, PHA â†’ â‘¥, íŠ¹ë³„í”¼ë‚œ â†’ â‘¦, ì™¸ë¶€ì¶œì…êµ¬ â†’ â‘§    
4. ë§¤í•‘ ë”•ì…”ë„ˆë¦¬ ì ìš©    
- "B/H08W" â†’ "B/H(08W)"   
- "25í†¤ ì¹´ê³ í¬ë ˆì¸" â†’ "ì¹´ê³ í¬ë ˆì¸(25T)"   
- "íŠ¹ê³µ" â†’ "ë³´í†µì¸ë¶€"    
- "ê¸°ê³„íƒ€ì„¤ê³µ" â†’ "íƒ€ì„¤ê³µ"    
- "ëª©ê³µì—°ìˆ˜ìƒ" ë˜ëŠ” "ëª©ìˆ˜ì—°ìˆ˜ìƒ" â†’ "ì—°ìˆ˜ìƒ"    
- "5í†¤íŠ¸ëŸ­" â†’ "í™”ë¬¼ì°¨(5T)"    
- "ì¹´ë¦¬í”„íŠ¸" â†’ "ì¹´ë¦¬í”„íŠ¸ê³µ"    
- "í•˜ì´ë“œë¡œí¬ë ˆì¸(20T)" â†’ "í•˜ì´ë“œë¡œí¬ë ˆì¸"    
- "ë¼ì´ë‹í¼ì¡°ë¦½" â†’ "ë¼ì´ë‹í¼ê³µ"  
- "S/Cíƒ€ì„¤íŒ€" â†’ "í„°ë„ê³µ"  
- "ëª©ìˆ˜" â†’ "ëª©ê³µ"    
5. ì‚¬ì „ì— ì—†ëŠ” í•­ëª© â†’ ìœ ì‚¬í•­ëª©, ì—†ìœ¼ë©´ **ì¸ì›: ë³´í†µì¸ë¶€ / ì¥ë¹„: ê¸°íƒ€** ë¡œ í•©ì‚°í•˜ê³  'ì˜¤ë¥˜ìš”ì•½'ì— ê¸°ì¬.
    
## 6. QA-CHECKLIST(ìë™ ê²€ì¦ í›„ ë³€í™˜ë¡œê·¸ ì¶œë ¥)
- **êµ¬ì¡°**: í…Œì´ë¸”/í–‰Â·ì—´ ê°œìˆ˜Â·ìˆœì„œ ì¼ì¹˜?    
- **ë¹ˆì…€ 0** ê·œì¹™ ì¤€ìˆ˜?    
- **ë°ì´í„°**: ì‹œê³µí˜„í™© ìˆ«ì, ì¸ì›Â·ì¥ë¹„ ì •ìˆ˜?    
- **ë§¤í•‘**: ë³€í™˜ ëˆ„ë½ ì—¬ë¶€?    
- **ëˆ„ë½/ì¤‘ë³µ**: ì›ë¬¸ ìˆ˜ëŸ‰ê³¼ 100 % ì¼ì¹˜?  
- **ë³€í™˜ë¡œê·¸**: ë§¤í•‘Â·ì •ê·œí™” ê³¼ì •ì—ì„œ ë°”ë€ ì›/ê²°ê³¼ ëª©ë¡(ìˆì„ ë•Œë§Œ ì¶œë ¥)
"""

def convert_pdf_to_images(pdf_file):
    """PDFë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜"""
    try:
        # PDF íŒŒì¼ì„ ì´ë¯¸ì§€ë¡œ ë³€í™˜ (300 DPIë¡œ ê³ í’ˆì§ˆ)
        images = convert_from_bytes(pdf_file.read(), dpi=300)
        pdf_file.seek(0)  # íŒŒì¼ í¬ì¸í„° ë¦¬ì…‹
        return images
    except Exception:
        return []

def extract_table_from_images_with_llm(images, file_type="ê³„ì¸¡ì¼ì§€"):
    """ì´ë¯¸ì§€ì—ì„œ LLMì„ ì‚¬ìš©í•˜ì—¬ í‘œ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜"""
    if not images:
        return None
    
    try:
        # í‘œ ì¶”ì¶œ ì „ìš© í”„ë¡¬í”„íŠ¸
        if file_type == "ê³„ì¸¡ì¼ì§€":
            image_prompt = '''
ì´ ì´ë¯¸ì§€ì—ì„œ ë°œíŒŒì§„ë™Â·ì†ŒìŒ ê³„ì¸¡ ë°ì´í„° í‘œë¥¼ ì°¾ì•„ ëª¨ë“  ì¸¡ì •ê°’ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

**ì¤‘ìš” ì§€ì‹œì‚¬í•­**:
1. Event List, ì¸¡ì •ê²°ê³¼, ê³„ì¸¡ë°ì´í„° ë“±ì˜ í‘œì—ì„œ ë°ì´í„° ì¶”ì¶œ
2. ëª¨ë“  ì‹œê°„ëŒ€ì˜ ë°ì´í„°ë¥¼ ë¹ ëœ¨ë¦¬ì§€ ë§ê³  ì¶”ì¶œ
3. AM/PM ì‹œê°„ì„ 24ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (ì˜ˆ: 1:47 PM â†’ 13:47, 8:05 AM â†’ 08:05)

**ì¶”ì¶œí•  ë°ì´í„°**:
- ì‹œê°„ (Time) - HH:MM 24ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
- Peak Particle Velocity Xì¶• (mm/sec)
- Peak Particle Velocity Yì¶• (mm/sec) 
- Peak Particle Velocity Zì¶• (mm/sec)
- LMax Sound Level (dBA)
- ì¸¡ì •ìœ„ì¹˜/ê³„ì¸¡ìœ„ì¹˜

**ì¶œë ¥ í˜•ì‹ (TSV)**:
ì‹œê°„	X_Axis	Y_Axis	Z_Axis	Sound	ì¸¡ì •ìœ„ì¹˜
08:05	0.710	0.650	0.580	61.2	ë„ë¦¼ì‚¬ê±°ë¦¬
13:47	0.880	0.750	0.620	53.2	ë„ë¦¼ì‚¬ê±°ë¦¬
16:10	0.920	0.680	0.590	-	ë„ë¦¼ì‚¬ê±°ë¦¬
16:40	0.850	0.790	0.650	61.2	ë„ë¦¼ì‚¬ê±°ë¦¬

**ì£¼ì˜ì‚¬í•­**:
- ê° ì¸¡ì • ì§€ì ë§ˆë‹¤ ë³„ë„ í–‰ìœ¼ë¡œ ì¶œë ¥
- ê°’ì´ ì—†ê±°ë‚˜ ì¸¡ì •ë˜ì§€ ì•Šì€ ê²½ìš° "-" í‘œì‹œ
- í—¤ë”ëŠ” ìœ„ í˜•ì‹ ê·¸ëŒ€ë¡œ ì‚¬ìš©
- TSV í˜•ì‹ (íƒ­ìœ¼ë¡œ êµ¬ë¶„)
- ì†Œìˆ˜ì  3ìë¦¬ê¹Œì§€ í‘œì‹œ
'''
        else:  # ë°œíŒŒì‘ì—…ì¼ì§€
            image_prompt = '''
ì´ ì´ë¯¸ì§€ì—ì„œ ë°œíŒŒ ì‘ì—… ê´€ë ¨ í‘œì˜ ë°ì´í„°ë¥¼ ì¶”ì¶œí•´ì„œ TSV í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•´ì£¼ì„¸ìš”.

ì¶”ì¶œí•  ì»¬ëŸ¼:
- ë°œíŒŒì¼ì
- ë°œíŒŒì‹œê°„
- ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg)
- ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg)
- í­ì•½ì‚¬ìš©ëŸ‰(kg)
- ë¹„ê³ 

ì¶œë ¥ í˜•ì‹:
- TSV (íƒ­ìœ¼ë¡œ êµ¬ë¶„)
- í—¤ë” í¬í•¨
- ìˆ«ìëŠ” ì†Œìˆ˜ì  3ìë¦¬ê¹Œì§€
- ë‚ ì§œëŠ” YYYY-MM-DD í˜•ì‹
- ì‹œê°„ì€ HH:MM í˜•ì‹
'''
        
        # ì²« ë²ˆì§¸ ì´ë¯¸ì§€ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ ì‹œë„
        best_result = None
        for i, image in enumerate(images):
            # ì´ë¯¸ì§€ë¥¼ Geminiì— ì „ì†¡
            response = GEMINI_MODEL.generate_content([image_prompt, image])
            
            if response.text and '\t' in response.text:
                # ë” ë§ì€ ë°ì´í„°ë¥¼ í¬í•¨í•œ ê²°ê³¼ë¥¼ ìš°ì„ ì„ íƒ
                if not best_result or len(response.text.split('\n')) > len(best_result.split('\n')):
                    best_result = response.text
        
        return best_result
        
    except Exception:
        return None

def extract_target_table(pdf_file):
    """PDFì—ì„œ íŠ¹ì • í…Œì´ë¸”ì„ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ ë°©ì‹)"""
    
    # 1ì°¨ ì‹œë„: í…ìŠ¤íŠ¸ ê¸°ë°˜ ì¶”ì¶œ
    found_tables = []
    try:
        with pdfplumber.open(pdf_file) as pdf:
            for page_num, page in enumerate(pdf.pages):
                for table_num, table in enumerate(page.extract_tables()):
                    if table and len(table) > 1:
                        # í—¤ë”ê°€ Noneì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì²˜ë¦¬
                        clean_headers = [str(col).strip() if col is not None else f"Col_{i}" for i, col in enumerate(table[0])]
                        
                        # ë°ì´í„° í–‰ ì •ë¦¬
                        clean_data = []
                        for row in table[1:]:
                            clean_row = [str(cell).strip() if cell is not None else "" for cell in row]
                            clean_data.append(clean_row)
                        
                        df = pd.DataFrame(clean_data, columns=clean_headers)
                        
                        # ë°œíŒŒ ê´€ë ¨ í‚¤ì›Œë“œê°€ í¬í•¨ëœ í…Œì´ë¸” ì°¾ê¸° (ì¡°ê±´ ì™„í™”)
                        column_text = ' '.join([str(col) for col in df.columns if col])
                        data_text = ' '.join([str(cell) for row in clean_data[:3] for cell in row])  # ì²« 3í–‰ë§Œ í™•ì¸
                        all_text = (column_text + ' ' + data_text).lower()
                        
                        # ë” ë„“ì€ ë²”ìœ„ì˜ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰
                        blast_keywords = ['ë°œíŒŒ', 'ì‹œê°„', 'ì¥ì•½', 'í­ì•½', 'ë¹„ê³ ', 'ì¼ì', 'ë‚ ì§œ', 'time', 'blast', 'charge']
                        
                        if any(keyword in all_text for keyword in blast_keywords):
                            found_tables.append({
                                'page': page_num + 1,
                                'table': table_num + 1,
                                'dataframe': df,
                                'columns': clean_headers,
                                'text_sample': all_text[:200]
                            })
    except Exception as e:
        print(f"í…ìŠ¤íŠ¸ ê¸°ë°˜ ì¶”ì¶œ ì˜¤ë¥˜: {e}")
    
    # ê°€ì¥ ì í•©í•œ í…Œì´ë¸” ì„ íƒ (ë” ë§ì€ ì»¬ëŸ¼ì„ ê°€ì§„ ê²ƒ ìš°ì„ )
    if found_tables:
        best_table = max(found_tables, key=lambda x: len(x['dataframe'].columns))
        return best_table['dataframe']
    
    # 2ì°¨ ì‹œë„: ì´ë¯¸ì§€ ê¸°ë°˜ ì¶”ì¶œ
    pdf_file.seek(0)  # íŒŒì¼ í¬ì¸í„° ë¦¬ì…‹
    images = convert_pdf_to_images(pdf_file)
    
    if images:
        table_text = extract_table_from_images_with_llm(images, "ì‘ì—…ì¼ì§€")
        if table_text:
            try:
                # TSV í…ìŠ¤íŠ¸ë¥¼ DataFrameìœ¼ë¡œ ë³€í™˜
                tsv_data = extract_tsv_from_response(table_text)
                tsv_data = fix_tsv_field_count(tsv_data)
                df = pd.read_csv(io.StringIO(tsv_data), sep='\t', encoding='utf-8')
                return df
            except Exception:
                pass
    
    return None

def extract_file_content(file):
    """íŒŒì¼ì—ì„œ í…ìŠ¤íŠ¸ ë‚´ìš©ì„ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (Gemini ì§ì ‘ PDF ì²˜ë¦¬)

    ê° PDFì—ì„œ í‘œ í˜•íƒœì˜ ë°ì´í„°ë¥¼ ìµœëŒ€í•œ ì›ë³¸ì— ê°€ê¹ê²Œ TSVë¡œ ì¶”ì¶œí•˜ëŠ” ë° ì§‘ì¤‘í•©ë‹ˆë‹¤.
    ë³µì¡í•œ ë°ì´í„° ë³€í™˜ì´ë‚˜ íŒŒì¼ ê°„ ë³‘í•©ì€ ë©”ì¸ í”„ë¡¬í”„íŠ¸ì—ì„œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
    """
    if file.name.endswith('.pdf'):
        try:
            file_content = file.read()
            file.seek(0)
            if not file_content.startswith(b'%PDF'):
                st.error("âŒ ì—…ë¡œë“œëœ íŒŒì¼ì´ ìœ íš¨í•œ PDF í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.")
                return None
        except Exception as e:
            st.error(f"âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: {str(e)}")
            return None

        filename_lower = file.name.lower()
        is_measurement_file = any(keyword in filename_lower for keyword in 
                                 ["ê³„ì¸¡", "ì§„ë™", "ì†ŒìŒ", "measurement", "vibration", "noise"])
        is_blast_log_file = any(keyword in filename_lower for keyword in 
                                 ["ë°œíŒŒ", "ì‘ì—…", "ì¼ì§€", "blast", "work", "log"])

        pdf_prompt = ""
        if is_measurement_file:
            pdf_prompt = '''
ì´ PDF íŒŒì¼ì€ 'ë°œíŒŒì§„ë™ì†ŒìŒ ê³„ì¸¡ì¼ì§€'ì…ë‹ˆë‹¤. ë‹¤ìŒ ì§€ì¹¨ì— ë”°ë¼ ë°ì´í„°ë¥¼ TSV í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

**ì¤‘ìš” ì§€ì‹œì‚¬í•­**:
1.  PDF í˜ì´ì§€ë¥¼ ìˆœì„œëŒ€ë¡œ ì½ìœ¼ë©´ì„œ "ê³„ì¸¡ : [ìœ„ì¹˜ëª…]" ë˜ëŠ” "Location : [Location Name]" íŒ¨í„´ì„ ì°¾ìŠµë‹ˆë‹¤.
2.  í•´ë‹¹ íŒ¨í„´ ë°”ë¡œ ë‹¤ìŒì— ë‚˜ì˜¤ëŠ” ë°ì´í„° í…Œì´ë¸”ì—ì„œ ë‹¤ìŒ ì›ë³¸ ì»¬ëŸ¼ë“¤ì˜ ëª¨ë“  í–‰ì„ ì¶”ì¶œí•©ë‹ˆë‹¤:
    - "Date/Time" (ë˜ëŠ” ìœ ì‚¬í•œ ë‚ ì§œ/ì‹œê°„ ì»¬ëŸ¼)
    - "Peak Particle Vel (X_Axis) (mm/sec)" (ë˜ëŠ” Xì¶• ì§„ë™ ê´€ë ¨ ì»¬ëŸ¼)
    - "Peak Particle Vel (Y_Axis) (mm/sec)" (ë˜ëŠ” Yì¶• ì§„ë™ ê´€ë ¨ ì»¬ëŸ¼)
    - "Peak Particle Vel (Z_Axis) (mm/sec)" (ë˜ëŠ” Zì¶• ì§„ë™ ê´€ë ¨ ì»¬ëŸ¼)
    - "LMax (Sound) (dBA)" (ë˜ëŠ” ì†ŒìŒ ê´€ë ¨ ì»¬ëŸ¼)
3.  ì¶”ì¶œëœ ë°ì´í„°ì— 'ì¸¡ì •ìœ„ì¹˜' ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ê³ , 1ë²ˆì—ì„œ ì°¾ì€ [ìœ„ì¹˜ëª…]ì„ ëª¨ë“  í–‰ì— ë°˜ë³µí•˜ì—¬ ì…ë ¥í•©ë‹ˆë‹¤.
4.  ë‚ ì§œ/ì‹œê°„ì€ ì›ë³¸ ê·¸ëŒ€ë¡œ (ì˜ˆ: "7/27/2023 1:47:39 PM") ì¶”ì¶œí•©ë‹ˆë‹¤. ë³€í™˜ì€ ë‚˜ì¤‘ì— í•©ë‹ˆë‹¤.

**ì¶œë ¥ TSV í—¤ë” ë° ì˜ˆì‹œ (ì‹¤ì œ ì¶”ì¶œë˜ëŠ” ì»¬ëŸ¼ëª…ì€ ì›ë³¸ PDFë¥¼ ë”°ë¦„)**:
Date/Time	Peak Particle Vel (X_Axis) (mm/sec)	Peak Particle Vel (Y_Axis) (mm/sec)	Peak Particle Vel (Z_Axis) (mm/sec)	LMax (Sound) (dBA)	ì¸¡ì •ìœ„ì¹˜
7/27/2023 1:47:39 PM	0.62	0.36	0.71	61.23	ì–‘ë§ì§‘
7/27/2023 4:10:12 PM	0.29	0.28	0.59	58.15	ì–‘ë§ì§‘
7/27/2023 4:10:08 PM	0.26	0.44	0.88	47.96	í‹°ìŠ¤í…Œì´ì…˜
7/27/2023 1:47:34 PM	0.60	0.56	0.87	53.29	í‹°ìŠ¤í…Œì´ì…˜

ê°’ì´ ì—†ê±°ë‚˜ í•´ë‹¹ ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë˜ëŠ” "-"ë¡œ í‘œì‹œí•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ TSV ë°ì´í„°ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
'''
        elif is_blast_log_file:
            pdf_prompt = '''
ì´ PDF íŒŒì¼ì€ 'ë°œíŒŒì‘ì—…ì¼ì§€'ì…ë‹ˆë‹¤. ë‹¤ìŒ ì§€ì¹¨ì— ë”°ë¼ ì£¼ìš” ë°ì´í„°ë¥¼ TSV í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

**ì¶”ì¶œ ëŒ€ìƒ ì»¬ëŸ¼ (PDFì— ìˆëŠ” ì‹¤ì œ ì»¬ëŸ¼ëª… ê¸°ì¤€, ì•„ë˜ëŠ” í‘œì¤€ ì˜ˆì‹œ)**:
- ë°œíŒŒì¼ì (ë˜ëŠ” Date, ë‚ ì§œ ë“±)
- ë°œíŒŒì‹œê°„ (ë˜ëŠ” Time, ì‹œê°„ ë“±)
- ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg) (ë˜ëŠ” Min Charge per Hole ë“±)
- ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg) (ë˜ëŠ” Max Charge per Hole ë“±)
- í­ì•½ì‚¬ìš©ëŸ‰(kg) (ë˜ëŠ” Total Explosives ë“±)
- ë¹„ê³  (ë˜ëŠ” Remarks, ê¸°íƒ€ ë“±)

**ì¶œë ¥ í˜•ì‹ (TSV)**:
- í—¤ë”ëŠ” PDFì˜ ì‹¤ì œ ì»¬ëŸ¼ëª…ì„ ë”°ë¥´ì„¸ìš”.
- ëª¨ë“  ê´€ë ¨ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.
- ë‚ ì§œì™€ ì‹œê°„ì€ ì›ë³¸ í˜•ì‹ ê·¸ëŒ€ë¡œ ì¶”ì¶œí•˜ì„¸ìš”.

**ì˜ˆì‹œ (ì‹¤ì œ ì»¬ëŸ¼ëª…ê³¼ ë°ì´í„°ëŠ” PDF ë‚´ìš©ì— ë”°ë¼ ë‹¤ë¦„)**:
ë°œíŒŒì¼ì	ë°œíŒŒì‹œê°„	ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg)	ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg)	í­ì•½ì‚¬ìš©ëŸ‰(kg)	ë¹„ê³ 
2023-10-26	13:47	0.050	0.100	150.000	ì•”ë°˜ ë°œíŒŒ (êµ´ì°© ì‘ì—…)
2023-10-26	16:10	0.060	0.120	180.000	2ì°¨ ë°œíŒŒ (í„°ë„ í™•ì¥)

ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ TSV ë°ì´í„°ë§Œ ì¶œë ¥í•˜ì„¸ìš”.
'''
        else:
            # íŒŒì¼ ìœ í˜•ì„ íŠ¹ì •í•  ìˆ˜ ì—†ëŠ” ê²½ìš°, ì¼ë°˜ì ì¸ í‘œ ì¶”ì¶œ ì‹œë„ (ì„ íƒì )
            st.warning("âš ï¸ íŒŒì¼ ìœ í˜•ì„ íŠ¹ì •í•  ìˆ˜ ì—†ì–´ ì¼ë°˜ í‘œ ì¶”ì¶œì„ ì‹œë„í•©ë‹ˆë‹¤. ê²°ê³¼ê°€ ì •í™•í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            pdf_prompt = "ì´ PDFì—ì„œ ê°€ì¥ ì¤‘ìš”í•´ ë³´ì´ëŠ” í‘œë¥¼ ì°¾ì•„ TSV í˜•ì‹ìœ¼ë¡œ ì¶”ì¶œí•´ì£¼ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª…ì€ ìƒëµí•˜ê³  TSV ë°ì´í„°ë§Œ ì¶œë ¥í•˜ì„¸ìš”."

        if not pdf_prompt:
             st.error("âŒ PDF íŒŒì¼ ìœ í˜•ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ë°œíŒŒì‘ì—…ì¼ì§€ ë˜ëŠ” ê³„ì¸¡ì¼ì§€)")
             return None

        try:
            file.seek(0)
            uploaded_file = genai.upload_file(file, mime_type="application/pdf")
            response = GEMINI_MODEL.generate_content([pdf_prompt, uploaded_file])
            genai.delete_file(uploaded_file.name)

            if response.text:
                # ì‘ë‹µ ì•ë’¤ì˜ ë§ˆí¬ë‹¤ìš´ ì½”ë“œ ë¸”ë¡ ì œê±° ë° ê³µë°± ì œê±°
                cleaned_response = response.text.strip()
                if cleaned_response.startswith("```tsv"):
                    cleaned_response = cleaned_response[len("```tsv"):].strip()
                elif cleaned_response.startswith("```"):
                    cleaned_response = cleaned_response[len("```"):].strip()
                if cleaned_response.endswith("```"):
                    cleaned_response = cleaned_response[:-len("```")].strip()
                return cleaned_response
            else:
                st.error(f"âŒ {file.name}ì—ì„œ AIê°€ ë‚´ìš©ì„ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                return None

        except Exception as e:
            st.error(f"âŒ {file.name} ì²˜ë¦¬ ì¤‘ AI ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
            # ë°±ì—… ë¡œì§ (PyPDF2, pdfplumber ë“±)ì€ ì—¬ê¸°ì„œ ì œê±°í•˜ê³ , í•„ìš”ì‹œ ë©”ì¸ ë¡œì§ì—ì„œ ì¬ì‹œë„ ê³ ë ¤
            return None
        
    elif file.name.endswith(('.xlsx', '.xls')):
        try:
            df = pd.read_excel(file, engine='openpyxl')
            df = df.fillna('-') 
            # ì—‘ì…€ì€ ë¹„êµì  ì •í˜•í™”ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œ ê°„ë‹¨í•œ ë¬¸ìì—´ ë³€í™˜ í›„ TSVë¡œ ë°˜í™˜
            return df.to_csv(sep='\t', index=False, encoding='utf-8')
        except Exception as e:
            st.error(f"âŒ ì—‘ì…€ ë°ì´í„° ì¶”ì¶œ ì‹¤íŒ¨: {str(e)}")
            return None
    elif file.name.endswith('.docx'):
        st.warning("âš ï¸ ì›Œë“œ íŒŒì¼ ì²˜ë¦¬ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return None # ë˜ëŠ” "ì›Œë“œ íŒŒì¼ ì²˜ë¦¬ ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
    
    st.error(f"âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: {file.name}")
    return None

def parse_tsv_to_dataframe(tsv_content):
    """TSV í˜•ì‹ì˜ ë¬¸ìì—´ì„ DataFrameìœ¼ë¡œ ë³€í™˜
    
    Args:
        tsv_content (str): TSV í˜•ì‹ì˜ ë¬¸ìì—´
        
    Returns:
        pd.DataFrame: ë³€í™˜ëœ DataFrame ë˜ëŠ” None
    """
    try:
        # ë¹ˆ ì¤„ ì œê±° ë° ê³µë°± ë¬¸ì ì²˜ë¦¬
        cleaned_content = '\n'.join(line.strip() for line in tsv_content.split('\n') if line.strip())
        
        # TSV ë¬¸ìì—´ì„ DataFrameìœ¼ë¡œ ë³€í™˜
        df = pd.read_csv(io.StringIO(cleaned_content), sep='\t', encoding='utf-8')
        
        # ì»¬ëŸ¼ëª…ì—ì„œ ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°
        df.columns = df.columns.str.strip()
        
        # None ê°’ì„ ë¹ˆ ë¬¸ìì—´ë¡œ ë³€í™˜
        df = df.fillna('')
        
        return df
    except Exception as e:
        st.error(f"TSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

def extract_tsv_from_response(response_text):
    """LLM ì‘ë‹µì—ì„œ TSV ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ëŠ” í•¨ìˆ˜ (ê°•í™”ëœ ë²„ì „)
    
    Args:
        response_text (str): LLMì˜ ì‘ë‹µ í…ìŠ¤íŠ¸
        
    Returns:
        str: ì¶”ì¶œëœ TSV ë°ì´í„° (ì•ë’¤ ê³µë°± ë° ì½”ë“œë¸”ë¡ ë§ˆì»¤ ì œê±°ë¨)
             ì¶”ì¶œ ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ì˜ ì£¼ìš” ë¶€ë¶„ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´ ë°˜í™˜ ì‹œë„.
    """
    if not response_text:
        return ""

    lines = response_text.strip().split('\n')
    cleaned_lines = []

    # 1. ì½”ë“œ ë¸”ë¡ ë§ˆì»¤ ë° ì–¸ì–´ ì§€ì •ì ì œê±° ì‹œë„
    temp_lines = []
    in_code_block = False
    for line in lines:
        stripped_line = line.strip()
        if stripped_line.startswith("```") and not in_code_block:
            # ì½”ë“œ ë¸”ë¡ ì‹œì‘ (```tsv, ```python ë“±) ë˜ëŠ” ``` ë‹¨ë…
            in_code_block = True
            # ``` ë‹¤ìŒì˜ ì–¸ì–´ ì§€ì •ì ì œê±° (ì˜ˆ: ```tsv -> ê³µë°±)
            content_after_ticks = stripped_line[3:].strip()
            if content_after_ticks and not '\t' in content_after_ticks: # ì–¸ì–´ ì§€ì •ìì¼ ê°€ëŠ¥ì„±
                continue # ì–¸ì–´ ì§€ì •ì ë¼ì¸ ìì²´ëŠ” ì¶”ê°€ ì•ˆ í•¨
            elif '\t' in content_after_ticks: # ``` ë’¤ì— ë°”ë¡œ TSV ë°ì´í„°ê°€ ì˜¨ ê²½ìš°
                 temp_lines.append(content_after_ticks)
            continue
        elif stripped_line.startswith("```") and in_code_block:
            # ì½”ë“œ ë¸”ë¡ ë
            in_code_block = False
            continue
        
        if in_code_block:
            temp_lines.append(line) # ì½”ë“œ ë¸”ë¡ ë‚´ë¶€ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
        else:
            # ì½”ë“œ ë¸”ë¡ ë°”ê¹¥ì˜ ë‚´ìš©ì€ ì¼ë‹¨ ëª¨ë‘ ì¶”ê°€ (ë‚˜ì¤‘ì— TSVì¸ì§€ ê²€ì‚¬)
            temp_lines.append(line)
    
    lines = temp_lines # ì½”ë“œ ë¸”ë¡ ì²˜ë¦¬ëœ ë¼ì¸ë“¤ë¡œ êµì²´

    # 2. TSV ë°ì´í„° ì˜ì—­ ì°¾ê¸° (í—¤ë” ê¸°ë°˜)
    # BLAST_EXTRACTION_PROMPTì˜ ìµœì¢… í—¤ë”ì™€ ìœ ì‚¬í•œ íŒ¨í„´ì„ ì°¾ìŒ
    expected_headers = ["ë°œíŒŒì¼ì", "ë°œíŒŒì‹œê°„", "ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœì†Œ, kg)", "ì§€ë°œë‹¹ì¥ì•½ëŸ‰(ìµœëŒ€, kg)", 
                        "í­ì•½ì‚¬ìš©ëŸ‰(kg)", "ë°œíŒŒì§„ë™(cm/sec)", "ë°œíŒŒì†ŒìŒ(dB(A))", "ê³„ì¸¡ìœ„ì¹˜", "ë¹„ê³ "]
    
    tsv_start_index = -1
    best_match_count = 0

    for i, line in enumerate(lines):
        # í˜„ì¬ ë¼ì¸ì´ í—¤ë”ì¼ ê°€ëŠ¥ì„±ì´ ìˆëŠ”ì§€ ê²€ì‚¬ (ìµœì†Œ 3ê°œ ì´ìƒ í—¤ë” í‚¤ì›Œë“œ í¬í•¨)
        current_line_headers = [header for header in expected_headers if header in line]
        if len(current_line_headers) >= 3 and '\t' in line:
            # ë” ë§ì€ í—¤ë” í‚¤ì›Œë“œë¥¼ í¬í•¨í•˜ëŠ” ë¼ì¸ì„ ìš°ì„ ì ìœ¼ë¡œ í—¤ë”ë¡œ ê°„ì£¼
            if len(current_line_headers) > best_match_count:
                best_match_count = len(current_line_headers)
                tsv_start_index = i
    
    if tsv_start_index != -1:
        # í—¤ë”ë¶€í„° ì‹œì‘í•˜ì—¬ ìœ íš¨í•œ TSV ë¼ì¸ë“¤ë§Œ ì¶”ì¶œ
        for i in range(tsv_start_index, len(lines)):
            line_to_check = lines[i].strip()
            # ìµœì†Œ 1ê°œ ì´ìƒì˜ íƒ­ì´ ìˆê³ , ë°ì´í„°ë¡œ ë³´ì´ëŠ” ë¼ì¸ë§Œ í¬í•¨
            # (ë„ˆë¬´ ì§§ê±°ë‚˜, íŠ¹ì • ì„¤ëª…ì¡°ì˜ ë¬¸ì¥ë¶€í˜¸ë¡œ ì‹œì‘í•˜ëŠ” ë“± ì œì™¸ ê°€ëŠ¥)
            if '\t' in line_to_check and len(line_to_check.split('\t')) > 2: # ìµœì†Œ 3ì»¬ëŸ¼ ì´ìƒ
                cleaned_lines.append(line_to_check)
            elif cleaned_lines: # ì´ë¯¸ TSV ë°ì´í„° ìˆ˜ì§‘ ì¤‘ì´ì—ˆë‹¤ë©´, ì—¬ê¸°ì„œ ì¤‘ë‹¨
                break
    
    # 3. í—¤ë” ê¸°ë°˜ìœ¼ë¡œ ëª» ì°¾ì•˜ì„ ê²½ìš°, ì „ì²´ ë¼ì¸ ì¤‘ íƒ­ í¬í•¨ ë¼ì¸ë§Œ ì„ íƒ (ìµœí›„ì˜ ìˆ˜ë‹¨)
    if not cleaned_lines:
        for line in lines:
            if '\t' in line.strip():
                cleaned_lines.append(line.strip())

    if not cleaned_lines:
        # ê·¸ë˜ë„ ëª» ì°¾ìœ¼ë©´, ì›ë³¸ì—ì„œ ì•ë¶€ë¶„ ì¼ë¶€ë¼ë„ ë°˜í™˜ ì‹œë„ (ë””ë²„ê¹…ìš©)
        # st.warning("TSV ë°ì´í„°ë¥¼ ì •í™•íˆ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. AI ì‘ë‹µ ì¼ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
        return "\n".join(lines[:15]).strip() # ìµœëŒ€ 15ì¤„

    return "\n".join(cleaned_lines)

# TSV í•„ë“œ ê°œìˆ˜ ìë™ ë³´ì • í•¨ìˆ˜ ì¶”ê°€
def fix_tsv_field_count(tsv_str):
    """TSV ë°ì´í„°ì˜ í•„ë“œ ìˆ˜ë¥¼ í—¤ë”ì™€ ë§ì¶° ë³´ì •í•˜ëŠ” í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)"""
    lines = tsv_str.strip().split('\n')
    if not lines:
        return tsv_str
    
    header = lines[0]
    n_fields = header.count('\t') + 1
    fixed_lines = [header]
    
    for i, line in enumerate(lines[1:], 2):
        fields = line.split('\t')
        
        # í•„ë“œê°€ ë¶€ì¡±í•œ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ ì±„ì›€
        if len(fields) < n_fields:
            fields += [''] * (n_fields - len(fields))
        # í•„ë“œê°€ ë§ì€ ê²½ìš° ë§ˆì§€ë§‰ í•„ë“œì— í•©ì¹¨
        elif len(fields) > n_fields:
            # í…ìŠ¤íŠ¸ ë°ì´í„°ì— íƒ­ì´ í¬í•¨ëœ ê²½ìš°ë¥¼ ê³ ë ¤í•˜ì—¬ ë§ˆì§€ë§‰ í•„ë“œì— ê²°í•©
            extra_fields = fields[n_fields-1:]
            fields = fields[:n_fields-1] + [' '.join(extra_fields)]
        
        fixed_lines.append('\t'.join(fields))
    
    return '\n'.join(fixed_lines)

def validate_and_clean_tsv(tsv_str):
    """TSV ë°ì´í„°ë¥¼ ê²€ì¦í•˜ê³  ì •ì œí•˜ëŠ” í•¨ìˆ˜"""
    if not tsv_str or not tsv_str.strip():
        return ""
    
    lines = tsv_str.strip().split('\n')
    if not lines:
        return ""
    
    # ë¹ˆ ë¼ì¸ ì œê±°
    lines = [line for line in lines if line.strip()]
    
    if not lines:
        return ""
    
    # í—¤ë” ê²€ì¦
    header = lines[0]
    if '\t' not in header:
        # í—¤ë”ì— íƒ­ì´ ì—†ìœ¼ë©´ TSVê°€ ì•„ë‹ ê°€ëŠ¥ì„±
        return ""
    
    n_fields = header.count('\t') + 1
    cleaned_lines = [header]
    
    # ê° ë¼ì¸ ê²€ì¦ ë° ì •ì œ
    for i, line in enumerate(lines[1:], 2):
        # ë¼ì¸ì´ ë„ˆë¬´ ë¹„ì •ìƒì ìœ¼ë¡œ ê¸¸ë©´ ê±´ë„ˆë›°ê¸°
        if len(line) > 10000:  # 10,000ì ì´ìƒì¸ ë¼ì¸ì€ ê±´ë„ˆë›°ê¸°
            continue
            
        fields = line.split('\t')
        
        # í•„ë“œ ìˆ˜ ì¡°ì •
        if len(fields) < n_fields:
            fields += [''] * (n_fields - len(fields))
        elif len(fields) > n_fields:
            # ì´ˆê³¼ í•„ë“œë¥¼ ë§ˆì§€ë§‰ í•„ë“œì— í•©ì¹˜ë˜, í•©ë¦¬ì ì¸ ê¸¸ì´ë¡œ ì œí•œ
            extra_text = ' '.join(fields[n_fields-1:])
            if len(extra_text) > 1000:  # ë„ˆë¬´ ê¸´ í…ìŠ¤íŠ¸ëŠ” ì˜ë¼ë‚´ê¸°
                extra_text = extra_text[:1000] + "..."
            fields = fields[:n_fields-1] + [extra_text]
        
        cleaned_lines.append('\t'.join(fields))
    
    return '\n'.join(cleaned_lines)

def remove_tsv_label(tsv_str):
    lines = tsv_str.strip().split('\n')
    if lines and lines[0].strip().lower() == "tsv":
        return '\n'.join(lines[1:])
    return tsv_str

def insert_blast_data_to_excel(blast_df, template_file, start_row=2, start_col=1):
    """
    ë°œíŒŒë°ì´í„°ë¥¼ ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼ì˜ ì§€ì •ëœ ìœ„ì¹˜ì— ì…ë ¥í•˜ëŠ” í•¨ìˆ˜
    
    Args:
        blast_df (pd.DataFrame): ë°œíŒŒë°ì´í„° DataFrame
        template_file: ì—…ë¡œë“œëœ ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼
        start_row (int): ë°ì´í„°ë¥¼ ì…ë ¥í•  ì‹œì‘ í–‰ (1-based)
        start_col (int): ë°ì´í„°ë¥¼ ì…ë ¥í•  ì‹œì‘ ì—´ (1-based)
    
    Returns:
        bytes: ìˆ˜ì •ëœ ì—‘ì…€ íŒŒì¼ì˜ ë°”ì´íŠ¸ ë°ì´í„°
    """
    try:
        # ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        wb = load_workbook(template_file)
        ws = wb.active  # ì²« ë²ˆì§¸ ì›Œí¬ì‹œíŠ¸ ì‚¬ìš©
        
        # í—¤ë” ì…ë ¥ (ì„ íƒì‚¬í•­) - B119ì—ëŠ” í—¤ë” ë¶ˆí•„ìš”í•˜ë¯€ë¡œ ì£¼ì„ ì²˜ë¦¬
        # for col_idx, column_name in enumerate(blast_df.columns):
        #     ws.cell(row=start_row-1, column=start_col+col_idx, value=column_name)
        
        # ë°ì´í„° ì…ë ¥
        for row_idx, row_data in enumerate(blast_df.itertuples(index=False)):
            for col_idx, cell_value in enumerate(row_data):
                ws.cell(row=start_row+row_idx, column=start_col+col_idx, value=cell_value)
        
        # ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì €ì¥
        output = io.BytesIO()
        wb.save(output)
        output.seek(0)
        return output.getvalue()
        
    except Exception as e:
        st.error(f"âŒ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

def insert_blast_data_to_excel_ae160(blast_df, template_file, start_row=160, start_col=31):
    """
    ë°œíŒŒë°ì´í„°ë¥¼ ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼ì˜ AE160 ìœ„ì¹˜ì— ì…ë ¥í•˜ëŠ” í•¨ìˆ˜
    
    Args:
        blast_df (pd.DataFrame): ë°œíŒŒë°ì´í„° DataFrame
        template_file: ì—…ë¡œë“œëœ ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼
        start_row (int): ë°ì´í„°ë¥¼ ì…ë ¥í•  ì‹œì‘ í–‰ (AE160ì˜ 160)
        start_col (int): ë°ì´í„°ë¥¼ ì…ë ¥í•  ì‹œì‘ ì—´ (AEì—´ = 31)
    
    Returns:
        bytes: ìˆ˜ì •ëœ ì—‘ì…€ íŒŒì¼ì˜ ë°”ì´íŠ¸ ë°ì´í„°
    """
    try:
        # ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        wb = load_workbook(template_file)
        ws = wb.active  # ì²« ë²ˆì§¸ ì›Œí¬ì‹œíŠ¸ ì‚¬ìš©
        
        # í—¤ë” ì…ë ¥í•˜ì§€ ì•ŠìŒ (AE160ì—ëŠ” í—¤ë” ë¶ˆí•„ìš”)
        
        # ë°ì´í„° ì…ë ¥
        for row_idx, row_data in enumerate(blast_df.itertuples(index=False)):
            for col_idx, cell_value in enumerate(row_data):
                ws.cell(row=start_row+row_idx, column=start_col+col_idx, value=cell_value)
        
        # ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì €ì¥
        output = io.BytesIO()
        wb.save(output)
        output.seek(0)
        return output.getvalue()
        
    except Exception as e:
        st.error(f"âŒ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

def insert_five_tables_to_excel(tables_data, template_file, table_positions=None):
    """
    5ê°œ í…Œì´ë¸”(ë‚ ì”¨ì •ë³´, ì‹œê³µí˜„í™©, ì‘ì—…ë‚´ìš©, ì¸ì›, ì¥ë¹„)ì„ ì—‘ì…€ íŒŒì¼ì˜ ì§€ì •ëœ ìœ„ì¹˜ì— ì…ë ¥í•˜ëŠ” í•¨ìˆ˜
    
    Args:
        tables_data (list): 5ê°œ í…Œì´ë¸”ì˜ DataFrame ë¦¬ìŠ¤íŠ¸
        template_file: ì—…ë¡œë“œëœ ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼
        table_positions (dict): ê° í…Œì´ë¸”ì˜ ìœ„ì¹˜ ì •ë³´ (ê¸°ë³¸ê°’ ì‚¬ìš©)
    
    Returns:
        bytes: ìˆ˜ì •ëœ ì—‘ì…€ íŒŒì¼ì˜ ë°”ì´íŠ¸ ë°ì´í„°
    """
    try:
        # ì—‘ì…€ íŒŒì¼ ë¡œë“œ
        wb = load_workbook(template_file)
        ws = wb.active  # ì²« ë²ˆì§¸ ì›Œí¬ì‹œíŠ¸ ì‚¬ìš©
        
        # ê¸°ë³¸ í…Œì´ë¸” ìœ„ì¹˜ ì„¤ì • (ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ìˆ˜ì •)
        if table_positions is None:
            table_positions = {
                "ë‚ ì”¨ì •ë³´": {"row": 5, "col": 30},    # AD5
                "ì‹œê³µí˜„í™©": {"row": 13, "col": 30},   # AD13
                "ì‘ì—…ë‚´ìš©": {"row": 48, "col": 30},   # AD48
                "ì¸ì›": {"row": 65, "col": 31},       # AE65
                "ì¥ë¹„": {"row": 111, "col": 31}       # AE111
            }
        
        table_names = ["ë‚ ì”¨ì •ë³´", "ì‹œê³µí˜„í™©", "ì‘ì—…ë‚´ìš©", "ì¸ì›", "ì¥ë¹„"]
        
        for i, (table_name, df) in enumerate(zip(table_names, tables_data)):
            if df is not None and not df.empty:
                pos = table_positions.get(table_name, {"row": 10 + i*20, "col": 30})
                start_row = pos["row"]
                start_col = pos["col"]
                
                # í—¤ë” ì…ë ¥
                for col_idx, column_name in enumerate(df.columns):
                    ws.cell(row=start_row, column=start_col+col_idx, value=column_name)
                
                # ë°ì´í„° ì…ë ¥
                for row_idx, row_data in enumerate(df.itertuples(index=False)):
                    for col_idx, cell_value in enumerate(row_data):
                        ws.cell(row=start_row+1+row_idx, column=start_col+col_idx, value=cell_value)
        
        # ë°”ì´íŠ¸ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ì €ì¥
        output = io.BytesIO()
        wb.save(output)
        output.seek(0)
        return output.getvalue()
        
    except Exception as e:
        st.error(f"âŒ ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        return None

# í˜ì´ì§€ ì„¤ì •
st.set_page_config(
    page_title="ê³µì‚¬ì¼ë³´ ìë™í™”",
    page_icon="ğŸ“",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# CSS ìŠ¤íƒ€ì¼ ì •ì˜
st.markdown("""
<style>
    .main {
        padding: 2rem;
    }
    .stApp {
        max-width: 1200px;
        margin: 0 auto;
    }
    .title-text {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1E3A8A;
        margin-bottom: 0.5rem;
    }
    .subtitle-text {
        font-size: 1.2rem;
        color: #4B5563;
        margin-bottom: 2rem;
    }
    .step-container {
        display: flex;
        justify-content: space-between;
        margin: 2rem 0;
        position: relative;
    }
    .step-container::before {
        content: '';
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background: #E5E7EB;
        z-index: 1;
    }
    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
    }
    .step-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #E5E7EB;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #4B5563;
    }
    .step.active .step-circle {
        background: #1E3A8A;
        color: white;
    }
    .step-label {
        font-size: 0.9rem;
        color: #4B5563;
        text-align: center;
    }
    .step.active .step-label {
        color: #1E3A8A;
        font-weight: 600;
    }
    .card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1E3A8A;
        margin-bottom: 1rem;
    }
    .card-description {
        color: #4B5563;
        margin-bottom: 1rem;
    }
    .stButton>button {
        background-color: #1E3A8A;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    .stButton>button:hover {
        background-color: #1E40AF;
        transform: translateY(-1px);
    }
    .stTextArea>div>div>textarea {
        border-radius: 0.375rem;
        border: 1px solid #E5E7EB;
        padding: 0.75rem;
    }
    .stTextArea>div>div>textarea:focus {
        border-color: #1E3A8A;
        box-shadow: 0 0 0 2px rgba(30,58,138,0.1);
    }
    
    /* í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    .modal-content {
        position: relative;
        background-color: white;
        margin: 5% auto;
        padding: 2rem;
        width: 80%;
        max-width: 800px;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .modal-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1E3A8A;
    }
    .close-button {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #4B5563;
    }
    .button-container {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    .stTextArea>div>div>textarea {
        min-height: 400px;
        font-family: monospace;
    }
    .prompt-editor {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
</style>
""", unsafe_allow_html=True)

# ì œëª© ë° ë¶€ì œëª©
st.markdown('<div class="title-text">ê³µì‚¬ì¼ë³´ ìë™í™”</div>', unsafe_allow_html=True)
st.markdown('<div class="subtitle-text">AI ê¸°ë°˜ ì‘ì—…ë³´ê³ ì„œ ìƒì„± ì‹œìŠ¤í…œ</div>', unsafe_allow_html=True)

# ë‹¨ê³„ í‘œì‹œ
st.markdown("""
<div class="step-container">
    <div class="step active">
        <div class="step-circle">1</div>
        <div class="step-label">í…ìŠ¤íŠ¸ ì…ë ¥</div>
    </div>
    <div class="step">
        <div class="step-circle">2</div>
        <div class="step-label">íŒŒì¼ ì—…ë¡œë“œ</div>
    </div>
    <div class="step">
        <div class="step-circle">3</div>
        <div class="step-label">ë¯¸ë¦¬ë³´ê¸°</div>
    </div>
    <div class="step">
        <div class="step-circle">4</div>
        <div class="step-label">ìŠ¹ì¸ ë° ë‹¤ìš´ë¡œë“œ</div>
    </div>
</div>
""", unsafe_allow_html=True)

# ìµœì´ˆ ì‹¤í–‰ ì‹œ ì„¸ì…˜ ìƒíƒœì— í”„ë¡¬í”„íŠ¸ ê°’ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
if "prompt" not in st.session_state:
    st.session_state["prompt"] = DEFAULT_PROMPT

# ì‘ì—… ì™„ë£Œ ìƒíƒœ ì¶”ì ì„ ìœ„í•œ ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if "kakao_work_completed" not in st.session_state:
    st.session_state["kakao_work_completed"] = False
if "blast_data_completed" not in st.session_state:
    st.session_state["blast_data_completed"] = False
if "processed_tables" not in st.session_state:
    st.session_state["processed_tables"] = []
if "blast_dataframe" not in st.session_state:
    st.session_state["blast_dataframe"] = None

# í…ìŠ¤íŠ¸ ì…ë ¥ ì¹´ë“œ
st.markdown('<div class="card">', unsafe_allow_html=True)
st.markdown('<div class="card-title">ì¹´ì¹´ì˜¤í†¡ ì‘ì—…ë³´ê³  ì…ë ¥</div>', unsafe_allow_html=True)
st.markdown('<div class="card-description">ì¼ì¼ì‘ì—…ë³´ê³  í…ìŠ¤íŠ¸</div>', unsafe_allow_html=True)

# í…ìŠ¤íŠ¸ ì…ë ¥ ì˜ì—­
kakao_text = st.text_area(
    "",
    placeholder="ì¹´ì¹´ì˜¤í†¡ì—ì„œ ê³µìœ ëœ ì‘ì—…ë³´ê³  ë‚´ìš©ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...",
    height=200
)

# ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
col1, col2 = st.columns([1, 1])

# AIë¡œ êµ¬ì¡°í™”í•˜ê¸° ë²„íŠ¼
with col1:
    if st.button("AIë¡œ êµ¬ì¡°í™”í•˜ê¸°", key="structure_button"):
        if kakao_text:
            try:
                prompt = st.session_state["prompt"] + "\n" + kakao_text
                response = GEMINI_MODEL.generate_content(prompt)
                preview_content = response.text
                tables = preview_content.split("```")
                table_names = ["ë‚ ì”¨ì •ë³´", "ì‹œê³µí˜„í™©", "ì‘ì—…ë‚´ìš©", "ì¸ì›", "ì¥ë¹„"]
                real_tables = []
                processed_tables = []  # DataFrame í˜•íƒœë¡œ ì €ì¥
                
                for table in tables:
                    tsv_candidate = table.strip()
                    # íƒ­ì´ ìˆìœ¼ë©´ ì¼ë‹¨ í…Œì´ë¸”ë¡œ ê°„ì£¼ (ì¡°ê±´ ì™„í™”)
                    if "\t" in tsv_candidate:
                        real_tables.append(tsv_candidate)
                
                for i, tsv_data in enumerate(real_tables):
                    tsv_data = remove_tsv_label(tsv_data)
                    tsv_data_fixed = fix_tsv_field_count(tsv_data)  # í•„ë“œ ê°œìˆ˜ ë³´ì •
                    if i < len(table_names):
                        st.subheader(f"{table_names[i]} í…Œì´ë¸”")
                    else:
                        st.subheader(f"í…Œì´ë¸” {i+1}")
                    df = parse_tsv_to_dataframe(tsv_data_fixed)
                    if df is not None:
                        st.dataframe(df.reset_index(drop=True))
                        processed_tables.append(df)  # DataFrame ì €ì¥
                    else:
                        st.warning(f"í…Œì´ë¸” {i+1}ì˜ ë°ì´í„°ë¥¼ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                        processed_tables.append(None)
                
                st.download_button(
                    label="ì „ì²´ ë¯¸ë¦¬ë³´ê¸° ë‹¤ìš´ë¡œë“œ",
                    data=preview_content,
                    file_name="ê³µì‚¬ì¼ë³´_ë¯¸ë¦¬ë³´ê¸°.txt",
                    mime="text/plain"
                )
                
                # 5ê°œ í…Œì´ë¸”ì´ ëª¨ë‘ ìƒì„±ëœ ê²½ìš° ì™„ë£Œ ìƒíƒœë¡œ ì €ì¥
                if len(processed_tables) >= 5 and any(df is not None for df in processed_tables):
                    st.session_state["kakao_work_completed"] = True
                    st.session_state["processed_tables"] = processed_tables
                    st.success("âœ… ì¹´ì¹´ì˜¤í†¡ ì‘ì—…ë³´ê³  ì²˜ë¦¬ ì™„ë£Œ!")
                    st.info("ğŸ“‹ ìƒì„±ëœ í…Œì´ë¸”: ë‚ ì”¨ì •ë³´, ì‹œê³µí˜„í™©, ì‘ì—…ë‚´ìš©, ì¸ì›, ì¥ë¹„")
                    
                    # ì…ë ¥ëœ í…Œì´ë¸” ì •ë³´
                    valid_tables = [name for i, name in enumerate(table_names) if i < len(processed_tables) and processed_tables[i] is not None]
                    st.info(f"ğŸ“Š ì²˜ë¦¬ëœ í…Œì´ë¸”: {', '.join(valid_tables)}")
                    
                    # ì§„í–‰ìƒí™© ì•ˆë‚´
                    if not st.session_state["blast_data_completed"]:
                        st.info("â³ ë°œíŒŒë°ì´í„° ì…ë ¥ì´ ì™„ë£Œë˜ë©´ ìƒ˜í”ŒíŒŒì¼ ì—…ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
            except Exception as e:
                st.error(f"ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
                st.error("ìƒì„¸ ì˜¤ë¥˜ ì •ë³´:")
                st.error(str(e))
        else:
            st.warning("ì¹´ì¹´ì˜¤í†¡ ì‘ì—…ë³´ê³  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ë²„íŠ¼
with col2:
    if st.button("í”„ë¡¬í”„íŠ¸ ìˆ˜ì •", key="edit_prompt_button"):
        st.session_state.show_prompt_modal = True

# í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ëª¨ë‹¬ (Streamlit ìœ„ì ¯ë§Œ ì‚¬ìš©)
if st.session_state.get('show_prompt_modal', False):
    st.markdown("### í”„ë¡¬í”„íŠ¸ ìˆ˜ì •", unsafe_allow_html=True)
    edited_prompt = st.text_area(
        "í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•˜ì„¸ìš”",
        value=st.session_state["prompt"],
        height=400,
        key="prompt_editor"
    )
    col1, col2, col3 = st.columns([1, 1, 1])
    with col1:
        if st.button("ì €ì¥", key="save_prompt_button"):
            st.session_state["prompt"] = edited_prompt
            st.session_state.show_prompt_modal = False
            st.experimental_rerun()
    with col2:
        if st.button("ì·¨ì†Œ", key="cancel_prompt_button"):
            st.session_state.show_prompt_modal = False
            st.experimental_rerun()
    with col3:
        if st.button("ë‹«ê¸°(X)", key="close_prompt_button"):
            st.session_state.show_prompt_modal = False
            st.experimental_rerun()

st.markdown('</div>', unsafe_allow_html=True)

# íŒŒì¼ ì—…ë¡œë“œ ì¹´ë“œ (ë‹¨ì¼ ì—…ë¡œë”ë§Œ ìœ ì§€)
st.markdown('<div class="card">', unsafe_allow_html=True)
st.markdown('<div class="card-title">íŒŒì¼ ì—…ë¡œë“œ</div>', unsafe_allow_html=True)

# ë°œíŒŒë°ì´í„° íŒŒì¼ ì—…ë¡œë“œ (ë‹¨ì¼ ì—…ë¡œë”)
blast_files = st.file_uploader(
    "ë°œíŒŒë°ì´í„° íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš” (PDF, ì—‘ì…€, ì›Œë“œ ì§€ì›)",
    type=["pdf", "xlsx", "xls", "docx"],
    accept_multiple_files=True
)

# íŒŒì¼ ìœ í˜• íŒë³„ í•¨ìˆ˜ ì¶”ê°€
def identify_blast_files(uploaded_files):
    """ì—…ë¡œë“œëœ íŒŒì¼ë“¤ì„ ë¶„ì„í•˜ì—¬ ë°œíŒŒì‘ì—…ì¼ì§€ì™€ ê³„ì¸¡ê²°ê³¼ ë³´ê³ ì„œë¥¼ êµ¬ë¶„í•˜ëŠ” í•¨ìˆ˜"""
    blast_log_file = None
    daily_report_file = None
    
    # íŒŒì¼ëª… ê¸°ë°˜ í‚¤ì›Œë“œ ë§¤ì¹­
    blast_log_keywords = ["ë°œíŒŒ", "ì‘ì—…", "ì¼ì§€", "blast", "work", "log"]
    measurement_keywords = ["ê³„ì¸¡", "ì§„ë™", "ì†ŒìŒ", "ë³´ê³ ì„œ", "measurement", "vibration", "noise", "report"]
    
    for uploaded_file in uploaded_files:
        filename_lower = uploaded_file.name.lower()
        
        # ë°œíŒŒì‘ì—…ì¼ì§€ í‚¤ì›Œë“œ ê²€ì‚¬
        if any(keyword in filename_lower for keyword in blast_log_keywords):
            if blast_log_file is None:  # ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ê²ƒë§Œ
                blast_log_file = uploaded_file
                continue
        
        # ê³„ì¸¡ê²°ê³¼ ë³´ê³ ì„œ í‚¤ì›Œë“œ ê²€ì‚¬
        if any(keyword in filename_lower for keyword in measurement_keywords):
            if daily_report_file is None:  # ì²« ë²ˆì§¸ë¡œ ë°œê²¬ëœ ê²ƒë§Œ
                daily_report_file = uploaded_file
                continue
    
    # í‚¤ì›Œë“œë¡œ êµ¬ë¶„ì´ ì•ˆë˜ë©´ ì—…ë¡œë“œ ìˆœì„œëŒ€ë¡œ í• ë‹¹
    if blast_log_file is None or daily_report_file is None:
        if len(uploaded_files) >= 2:
            if blast_log_file is None:
                blast_log_file = uploaded_files[0]
            if daily_report_file is None:
                daily_report_file = uploaded_files[1] if uploaded_files[1] != blast_log_file else None
    
    return blast_log_file, daily_report_file

if blast_files and len(blast_files) == 2:
    # íŒŒì¼ ìœ í˜• ìë™ íŒë³„
    blast_log_file, daily_report_file = identify_blast_files(blast_files)
    
    if blast_log_file and daily_report_file:
        st.info(f"ğŸ“„ ë°œíŒŒì‘ì—…ì¼ì§€: {blast_log_file.name}")
        st.info(f"ğŸ“Š ê³„ì¸¡ê²°ê³¼ ë³´ê³ ì„œ: {daily_report_file.name}")
        
        with st.spinner('ğŸ¤– AIê°€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...'):
            try:
                # ê° íŒŒì¼ ë‚´ìš© ì¶”ì¶œ
                blast_text = extract_file_content(blast_log_file)
                daily_text = extract_file_content(daily_report_file)
                
                # ë””ë²„ê¹…: ì¶”ì¶œëœ í…ìŠ¤íŠ¸ í™•ì¸
                with st.expander("ğŸ“„ ë°œíŒŒì‘ì—…ì¼ì§€ ì›ë³¸ TSV (ë””ë²„ê¹…)"):
                    st.text_area("ë°œíŒŒì‘ì—…ì¼ì§€ TSV", blast_text if blast_text else "ë‚´ìš© ì—†ìŒ", height=150)
                with st.expander("ğŸ“Š ê³„ì¸¡ì¼ì§€ ì›ë³¸ TSV (ë””ë²„ê¹…)"):
                    st.text_area("ê³„ì¸¡ì¼ì§€ TSV", daily_text if daily_text else "ë‚´ìš© ì—†ìŒ", height=150)
                
                if not blast_text or not daily_text:
                    st.error("âŒ íŒŒì¼ ë‚´ìš© ì¶”ì¶œì— ì‹¤íŒ¨í•˜ì—¬ ì²˜ë¦¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
                else:
                    prompt = BLAST_EXTRACTION_PROMPT + f"\n\n## ì…ë ¥ 1: ë°œíŒŒì‘ì—…ì¼ì§€_TSV\n{blast_text}\n\n## ì…ë ¥ 2: ê³„ì¸¡ì¼ì§€_TSV\n{daily_text}"
                    
                    # ë””ë²„ê¹…: ìµœì¢… í”„ë¡¬í”„íŠ¸ í™•ì¸
                    with st.expander("ğŸ” ìµœì¢… í”„ë¡¬í”„íŠ¸ (ë””ë²„ê¹…)"):
                        st.text_area("LLM ì „ë‹¬ í”„ë¡¬í”„íŠ¸", prompt, height=300)
                    
                    response = GEMINI_MODEL.generate_content(prompt)
                    
                    # ë””ë²„ê¹…: AI ì‘ë‹µ ì›ë³¸ í™•ì¸
                    with st.expander("ğŸ¤– AI ì‘ë‹µ ì›ë³¸ (ë””ë²„ê¹…)"):
                        st.text_area("AI ì‘ë‹µ", response.text if response.text else "ì‘ë‹µ ì—†ìŒ", height=200)
                    
                    tsv_result = response.text
                    tsv_data = extract_tsv_from_response(tsv_result)
                    
                    # ë””ë²„ê¹…: extract_tsv_from_response ê²°ê³¼ í™•ì¸
                    with st.expander("âœ‚ï¸ TSV ì¶”ì¶œ ê²°ê³¼ (ë””ë²„ê¹…)"):
                        st.text_area("ì¶”ì¶œëœ TSV ë¬¸ìì—´", tsv_data, height=200)
                    
                    if not tsv_data or not '\t' in tsv_data:
                        st.error("âŒ AI ì‘ë‹µì—ì„œ ìœ íš¨í•œ TSV ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
                        st.info("íŒ: AI ì‘ë‹µ ì›ë³¸ê³¼ TSV ì¶”ì¶œ ê²°ê³¼(ë””ë²„ê¹…ìš©)ë¥¼ í™•ì¸í•˜ì—¬, BLAST_EXTRACTION_PROMPT ë˜ëŠ” extract_tsv_from_response í•¨ìˆ˜ë¥¼ ì¡°ì •í•´ë³´ì„¸ìš”.")
                    else:
                        tsv_data = fix_tsv_field_count(tsv_data)  # í•„ë“œ ê°œìˆ˜ ë³´ì •
                        
                        # ì¶”ê°€ ê²€ì¦ ë° ì •ì œ
                        tsv_data = validate_and_clean_tsv(tsv_data)
                        
                        # ë””ë²„ê¹…: ë³´ì •ëœ TSV ë°ì´í„° í™•ì¸
                        with st.expander("ğŸ”§ ë³´ì •ëœ TSV ë°ì´í„° (ë””ë²„ê¹…)"):
                            st.text_area("ë³´ì •ëœ TSV ë¬¸ìì—´", tsv_data, height=200)
                        
                        try:
                            # TSV íŒŒì‹± ì‹œë„ (ìµœì‹  pandas ë²„ì „ìš©)
                            df = pd.read_csv(
                                io.StringIO(tsv_data), 
                                sep='\t', 
                                encoding='utf-8',
                                on_bad_lines='skip',  # ë¬¸ì œê°€ ìˆëŠ” ë¼ì¸ ê±´ë„ˆë›°ê¸°
                                engine='python'  # python ì—”ì§„ ì‚¬ìš©ìœ¼ë¡œ ì˜¤ë¥˜ ì²˜ë¦¬ ê°œì„ 
                            )
                        except Exception as csv_error:
                            st.warning(f"âš ï¸ ìµœì‹  pandas ì˜µì…˜ ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„: {csv_error}")
                            try:
                                # êµ¬ë²„ì „ pandas ë˜ëŠ” ëŒ€ì²´ ë°©ë²•
                                df = pd.read_csv(
                                    io.StringIO(tsv_data), 
                                    sep='\t', 
                                    encoding='utf-8',
                                    error_bad_lines=False,  # êµ¬ë²„ì „ìš©
                                    warn_bad_lines=True,
                                    engine='python'
                                )
                            except Exception as csv_error2:
                                st.error(f"âŒ TSV íŒŒì‹± ì‹¤íŒ¨: {csv_error2}")
                                # ìˆ˜ë™ìœ¼ë¡œ TSV íŒŒì‹± ì‹œë„
                                lines = tsv_data.strip().split('\n')
                                if lines:
                                    headers = lines[0].split('\t')
                                    data_rows = []
                                    for line in lines[1:]:
                                        row = line.split('\t')
                                        # ì»¬ëŸ¼ ìˆ˜ ë§ì¶”ê¸°
                                        if len(row) < len(headers):
                                            row += [''] * (len(headers) - len(row))
                                        elif len(row) > len(headers):
                                            row = row[:len(headers)]
                                        data_rows.append(row)
                                    df = pd.DataFrame(data_rows, columns=headers)
                                else:
                                    raise Exception("TSV ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
                        
                        df = df.fillna('-')
                        
                        st.success("âœ… ë°œíŒŒë°ì´í„° ë¶„ì„ ì™„ë£Œ!")
                        st.subheader("ğŸ“‹ ì¶”ì¶œëœ ë°œíŒŒë°ì´í„°")
                        st.dataframe(df.reset_index(drop=True))
                        st.download_button(
                            label="ğŸ“¥ TSV íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ",
                            data=df.to_csv(sep='\t', index=False, encoding='utf-8-sig'),
                            file_name="ë°œíŒŒë°ì´í„°.tsv",
                            mime="text/tab-separated-values",
                        )
                        
                        # ë°œíŒŒë°ì´í„° ì™„ë£Œ ìƒíƒœë¡œ ì €ì¥
                        st.session_state["blast_data_completed"] = True
                        st.session_state["blast_dataframe"] = df
                        st.success("âœ… ë°œíŒŒë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ!")
                        st.info(f"ğŸ“Š ì²˜ë¦¬ëœ ë°ì´í„°: {len(df)}í–‰ Ã— {len(df.columns)}ì—´")
                        
                        # ì§„í–‰ìƒí™© ì•ˆë‚´
                        if not st.session_state["kakao_work_completed"]:
                            st.info("â³ ì¹´ì¹´ì˜¤í†¡ ì‘ì—…ë³´ê³  ì…ë ¥ì´ ì™„ë£Œë˜ë©´ ìƒ˜í”ŒíŒŒì¼ ì—…ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
            except Exception as e:
                st.error(f"âŒ ë°ì´í„° ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
                st.error(f"ìƒì„¸ ì˜¤ë¥˜: {str(e)}")
    else:
        st.warning("âš ï¸ íŒŒì¼ ìœ í˜•ì„ ìë™ìœ¼ë¡œ êµ¬ë¶„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        st.info("íŒŒì¼ëª…ì— ë‹¤ìŒ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:")
        st.info("â€¢ ë°œíŒŒì‘ì—…ì¼ì§€: 'ë°œíŒŒ', 'ì‘ì—…', 'ì¼ì§€' ì¤‘ í•˜ë‚˜")
        st.info("â€¢ ê³„ì¸¡ê²°ê³¼ ë³´ê³ ì„œ: 'ê³„ì¸¡', 'ì§„ë™', 'ì†ŒìŒ', 'ë³´ê³ ì„œ' ì¤‘ í•˜ë‚˜")
elif blast_files and len(blast_files) == 1:
    st.info("ğŸ“ íŒŒì¼ 1ê°œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë°œíŒŒë°ì´í„° ë¶„ì„ì„ ìœ„í•´ì„œëŠ” 2ê°œ íŒŒì¼ì´ í•„ìš”í•©ë‹ˆë‹¤.")
elif blast_files and len(blast_files) > 2:
    st.warning("âš ï¸ íŒŒì¼ì´ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ë°œíŒŒì‘ì—…ì¼ì§€ì™€ ê³„ì¸¡ê²°ê³¼ ë³´ê³ ì„œ 2ê°œ íŒŒì¼ë§Œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")
else:
    st.info("ğŸ“ ë°œíŒŒë°ì´í„° ë¶„ì„ì„ ìœ„í•´ ê´€ë ¨ íŒŒì¼ 2ê°œë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.")

# ì‚¬ìš© ê°€ëŠ¥í•œ Gemini ëª¨ë¸ ëª©ë¡ì„ sidebarì— ì¶œë ¥ (ê°œë°œ/ë””ë²„ê¹…ìš©)
with st.sidebar:
    st.markdown('### ì‚¬ìš© ê°€ëŠ¥í•œ Gemini ëª¨ë¸ ëª©ë¡')
    try:
        models = genai.list_models()
        for m in models:
            st.write(f"- {m.name}")
            if hasattr(m, 'supported_generation_methods'):
                st.caption(f"ì§€ì› ë©”ì„œë“œ: {getattr(m, 'supported_generation_methods', None)}")
    except Exception as e:
        st.error(f"ëª¨ë¸ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: {str(e)}") 

# === AE160 ìë™ ì…ë ¥ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ í•„ìš” ===
# template_file ì—…ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ AE160ì— ë°ì´í„° ì…ë ¥í•˜ë„ë¡ ìˆ˜ì • í•„ìš”

st.markdown('</div>', unsafe_allow_html=True)

# í†µí•© ìƒ˜í”ŒíŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ (ë‘ ì‘ì—…ì´ ëª¨ë‘ ì™„ë£Œë˜ì—ˆì„ ë•Œë§Œ í‘œì‹œ)
if st.session_state["kakao_work_completed"] and st.session_state["blast_data_completed"]:
    st.markdown("---")
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<div class="card-title">ğŸ“Š ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼ì— ë°ì´í„° í†µí•© ì…ë ¥</div>', unsafe_allow_html=True)
    st.markdown('<div class="card-description">ì²˜ë¦¬ëœ ëª¨ë“  ë°ì´í„°ë¥¼ ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼ì˜ ì§€ì •ëœ ìœ„ì¹˜ì— ìë™ìœ¼ë¡œ ì…ë ¥í•©ë‹ˆë‹¤.</div>', unsafe_allow_html=True)
    
    # ì™„ë£Œëœ ì‘ì—… ìƒíƒœ í‘œì‹œ
    st.info("âœ… ì¹´ì¹´ì˜¤í†¡ ì‘ì—…ë³´ê³  ì²˜ë¦¬ ì™„ë£Œ")
    st.info("âœ… ë°œíŒŒë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ")
    
    # ìƒ˜í”Œ íŒŒì¼ ì—…ë¡œë“œ
    template_file = st.file_uploader(
        "ìƒ˜í”Œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”",
        type=["xlsx", "xls"],
        key="final_template_uploader"
    )
    
    if template_file:
        st.info("ğŸ“ ë°ì´í„° ì…ë ¥ ìœ„ì¹˜:")
        st.info("â€¢ ë‚ ì”¨ì •ë³´: AD5 | ì‹œê³µí˜„í™©: AD13 | ì‘ì—…ë‚´ìš©: AD48 | ì¸ì›: AE65 | ì¥ë¹„: AE111")
        st.info("â€¢ ë°œíŒŒë°ì´í„°: AE160")
        
        col1, col2 = st.columns(2)
        with col1:
            if st.button("ğŸ“ ëª¨ë“  ë°ì´í„° ì…ë ¥í•˜ê¸°", key="integrate_all_data"):
                with st.spinner('ğŸ“ ì—‘ì…€ íŒŒì¼ì— ëª¨ë“  ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ì…ë ¥í•˜ê³  ìˆìŠµë‹ˆë‹¤...'):
                    try:
                        # 1. ë¨¼ì € 5ê°œ í…Œì´ë¸” ì…ë ¥
                        modified_excel = insert_five_tables_to_excel(
                            st.session_state["processed_tables"], 
                            template_file
                        )
                        
                        if modified_excel:
                            # 2. ì„ì‹œ íŒŒì¼ë¡œ ì €ì¥ í›„ ë°œíŒŒë°ì´í„° ì¶”ê°€
                            temp_file = io.BytesIO(modified_excel)
                            final_excel = insert_blast_data_to_excel_ae160(
                                st.session_state["blast_dataframe"], 
                                temp_file
                            )
                            
                            if final_excel:
                                st.success("âœ… ëª¨ë“  ë°ì´í„° ì…ë ¥ ì™„ë£Œ!")
                                
                                # ìˆ˜ì •ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                                original_name = template_file.name
                                name_without_ext = original_name.rsplit('.', 1)[0]
                                extension = original_name.rsplit('.', 1)[1] if '.' in original_name else 'xlsx'
                                new_filename = f"{name_without_ext}_í†µí•©ë°ì´í„°ì…ë ¥.{extension}"
                                
                                st.download_button(
                                    label="ğŸ“¥ í†µí•© ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
                                    data=final_excel,
                                    file_name=new_filename,
                                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                                )
                                
                                # ì…ë ¥ëœ ë°ì´í„° ì •ë³´
                                st.info("ğŸ“Š ì…ë ¥ëœ ë°ì´í„°:")
                                st.info(f"â€¢ 5ê°œ í…Œì´ë¸”: ë‚ ì”¨ì •ë³´, ì‹œê³µí˜„í™©, ì‘ì—…ë‚´ìš©, ì¸ì›, ì¥ë¹„")
                                st.info(f"â€¢ ë°œíŒŒë°ì´í„°: {len(st.session_state['blast_dataframe'])}í–‰ Ã— {len(st.session_state['blast_dataframe'].columns)}ì—´")
                            else:
                                st.error("âŒ ë°œíŒŒë°ì´í„° ì…ë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                        else:
                            st.error("âŒ 5ê°œ í…Œì´ë¸” ì…ë ¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
                    except Exception as e:
                        st.error(f"âŒ ë°ì´í„° í†µí•© ì…ë ¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}")
        
        with col2:
            if st.button("ğŸ”„ ì‘ì—… ì´ˆê¸°í™”", key="reset_all_work"):
                st.session_state["kakao_work_completed"] = False
                st.session_state["blast_data_completed"] = False
                st.session_state["processed_tables"] = []
                st.session_state["blast_dataframe"] = None
                st.success("âœ… ëª¨ë“  ì‘ì—…ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.experimental_rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)

elif st.session_state["kakao_work_completed"] or st.session_state["blast_data_completed"]:
    st.markdown("---")
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<div class="card-title">ğŸ“‹ ì‘ì—… ì§„í–‰ ìƒí™©</div>', unsafe_allow_html=True)
    
    if st.session_state["kakao_work_completed"]:
        st.info("âœ… ì¹´ì¹´ì˜¤í†¡ ì‘ì—…ë³´ê³  ì²˜ë¦¬ ì™„ë£Œ")
    else:
        st.warning("â³ ì¹´ì¹´ì˜¤í†¡ ì‘ì—…ë³´ê³  ì…ë ¥ ëŒ€ê¸° ì¤‘")
    
    if st.session_state["blast_data_completed"]:
        st.info("âœ… ë°œíŒŒë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ")
    else:
        st.warning("â³ ë°œíŒŒë°ì´í„° ì…ë ¥ ëŒ€ê¸° ì¤‘")
    
    st.info("ğŸ’¡ ë‘ ì‘ì—…ì´ ëª¨ë‘ ì™„ë£Œë˜ë©´ ìƒ˜í”ŒíŒŒì¼ ì—…ë¡œë“œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.")
    
    if st.button("ğŸ”„ ì‘ì—… ì´ˆê¸°í™”", key="reset_partial_work"):
        st.session_state["kakao_work_completed"] = False
        st.session_state["blast_data_completed"] = False
        st.session_state["processed_tables"] = []
        st.session_state["blast_dataframe"] = None
        st.success("âœ… ëª¨ë“  ì‘ì—…ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.")
        st.experimental_rerun()
    
    st.markdown('</div>', unsafe_allow_html=True)

# ì‚¬ìš© ê°€ëŠ¥í•œ Gemini ëª¨ë¸ ëª©ë¡ì„ sidebarì— ì¶œë ¥ (ê°œë°œ/ë””ë²„ê¹…ìš©)